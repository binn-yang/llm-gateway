# LLM Gateway - é¡¹ç›®æ·±åº¦åˆ†ææŠ¥å‘Š

**é¡¹ç›®åç§°**: LLM Gateway
**ç‰ˆæœ¬**: 0.3.0
**ç¼–ç¨‹è¯­è¨€**: Rust (Edition 2021)
**ä»£ç è§„æ¨¡**: çº¦ 111,000 è¡Œä»£ç ï¼Œ70 ä¸ªæ–‡ä»¶
**åˆ†ææ—¥æœŸ**: 2026-01-08

---

## ç›®å½•

1. [æ‰§è¡Œæ‘˜è¦](#æ‰§è¡Œæ‘˜è¦)
2. [é¡¹ç›®æ¦‚è§ˆ](#é¡¹ç›®æ¦‚è§ˆ)
3. [æ¶æ„åˆ†æ](#æ¶æ„åˆ†æ)
4. [ä»£ç ç»“æ„åˆ†æ](#ä»£ç ç»“æ„åˆ†æ)
5. [æŠ€æœ¯æ ˆä¸ä¾èµ–](#æŠ€æœ¯æ ˆä¸ä¾èµ–)
6. [æ ¸å¿ƒåŠŸèƒ½ç‰¹æ€§](#æ ¸å¿ƒåŠŸèƒ½ç‰¹æ€§)
7. [æ€§èƒ½ä¸å¹¶å‘è®¾è®¡](#æ€§èƒ½ä¸å¹¶å‘è®¾è®¡)
8. [å®‰å…¨æ€§åˆ†æ](#å®‰å…¨æ€§åˆ†æ)
9. [å¯è§‚æµ‹æ€§](#å¯è§‚æµ‹æ€§)
10. [æµ‹è¯•ç­–ç•¥](#æµ‹è¯•ç­–ç•¥)
11. [éƒ¨ç½²ä¸è¿ç»´](#éƒ¨ç½²ä¸è¿ç»´)
12. [ä¼˜åŠ¿ä¸åˆ›æ–°ç‚¹](#ä¼˜åŠ¿ä¸åˆ›æ–°ç‚¹)
13. [æ”¹è¿›æœºä¼š](#æ”¹è¿›æœºä¼š)
14. [ç«äº‰åˆ†æ](#ç«äº‰åˆ†æ)
15. [æœªæ¥å‘å±•å»ºè®®](#æœªæ¥å‘å±•å»ºè®®)

---

## 1. æ‰§è¡Œæ‘˜è¦

### é¡¹ç›®å®šä½

LLM Gateway æ˜¯ä¸€ä¸ª**ä¼ä¸šçº§ã€é«˜æ€§èƒ½çš„ LLM ç»Ÿä¸€ä»£ç†ç½‘å…³**ï¼Œé‡‡ç”¨ Rust ç¼–å†™ï¼Œæä¾› OpenAI å…¼å®¹çš„ API æ¥å£ï¼Œæ”¯æŒå¤šä¸ª LLM æä¾›å•†ï¼ˆOpenAIã€Anthropic Claudeã€Google Geminiï¼‰çš„ç»Ÿä¸€è®¿é—®ã€åè®®è½¬æ¢ã€è´Ÿè½½å‡è¡¡å’Œæ•…éšœè½¬ç§»ã€‚

### æ ¸å¿ƒä»·å€¼

- **ç»Ÿä¸€æ¥å£**: å•ä¸€ OpenAI å…¼å®¹ APIï¼Œæ”¯æŒæ‰€æœ‰ä¸»æµ LLM æä¾›å•†
- **é›¶å¤–éƒ¨ä¾èµ–**: æ— éœ€ Redisã€æ•°æ®åº“ç­‰å¤–éƒ¨ç»„ä»¶ï¼Œéƒ¨ç½²ç®€å•
- **é«˜æ€§èƒ½**: Rust + Tokio å¼‚æ­¥è¿è¡Œæ—¶ï¼Œä½å»¶è¿Ÿã€é«˜åå
- **æ™ºèƒ½è´Ÿè½½å‡è¡¡**: åŸºäºä¼˜å…ˆçº§çš„ç²˜æ€§ä¼šè¯ï¼Œæœ€å¤§åŒ– KV ç¼“å­˜å‘½ä¸­ç‡
- **è‡ªåŠ¨æ•…éšœè½¬ç§»**: å•æ¬¡å¤±è´¥å³è§¦å‘æ•…éšœè½¬ç§»ï¼Œè‡ªåŠ¨æ¢å¤æœºåˆ¶
- **åè®®è½¬æ¢**: è‡ªåŠ¨å®Œæˆ OpenAI â†” Anthropic â†” Gemini æ ¼å¼è½¬æ¢

### æŠ€æœ¯äº®ç‚¹

| ç»´åº¦ | è¯„åˆ† | è¯´æ˜ |
|-----|------|------|
| **æ¶æ„è®¾è®¡** | â­â­â­â­â­ | æ¸…æ™°çš„åˆ†å±‚æ¶æ„ï¼ŒèŒè´£åˆ†ç¦»æ˜ç¡® |
| **ä»£ç è´¨é‡** | â­â­â­â­ | è‰¯å¥½çš„ Rust å®è·µï¼Œç±»å‹å®‰å…¨ï¼Œéƒ¨åˆ†å¯ä¼˜åŒ– |
| **æ€§èƒ½è®¾è®¡** | â­â­â­â­â­ | DashMapã€RwLockã€Arc ä¼˜åŒ–ï¼Œé«˜å¹¶å‘å‹å¥½ |
| **åŠŸèƒ½å®Œæ•´æ€§** | â­â­â­â­â­ | æ”¯æŒæµå¼ã€å·¥å…·è°ƒç”¨ã€è§†è§‰ã€ç¼“å­˜ç­‰é«˜çº§ç‰¹æ€§ |
| **å¯ç»´æŠ¤æ€§** | â­â­â­â­ | è‰¯å¥½çš„æ–‡æ¡£å’Œæ³¨é‡Šï¼Œæµ‹è¯•è¦†ç›–è¾ƒå¥½ |
| **å¯è§‚æµ‹æ€§** | â­â­â­â­ | Prometheus æŒ‡æ ‡ï¼Œç»“æ„åŒ–æ—¥å¿—ï¼Œå¾…ä¼˜åŒ– |
| **å®‰å…¨æ€§** | â­â­â­ | åŸºæœ¬å®‰å…¨æªæ–½åˆ°ä½ï¼Œç¼ºå°‘ Rate Limiting |

**æ€»ä½“è¯„åˆ†**: â­â­â­â­ (4.3/5.0)

---

## 2. é¡¹ç›®æ¦‚è§ˆ

### 2.1 é¡¹ç›®èƒŒæ™¯

åœ¨ AI åº”ç”¨å¼€å‘ä¸­ï¼Œå¼€å‘è€…ç»å¸¸éœ€è¦ï¼š
1. åŒæ—¶ä½¿ç”¨å¤šä¸ª LLM æä¾›å•†ï¼ˆOpenAIã€Claudeã€Geminiï¼‰
2. ä¸ºä¸åŒæä¾›å•†ç¼–å†™ä¸åŒçš„é›†æˆä»£ç 
3. æ‰‹åŠ¨å¤„ç†æ•…éšœè½¬ç§»å’Œè´Ÿè½½å‡è¡¡
4. ç®¡ç†å¤šå¥— API å¯†é’¥å’Œé…ç½®

LLM Gateway è§£å†³äº†è¿™äº›ç—›ç‚¹ï¼Œæä¾›äº†ä¸€ä¸ª**ç»Ÿä¸€çš„ç½‘å…³å±‚**ã€‚

### 2.2 æ ¸å¿ƒé—®é¢˜åŸŸ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              LLM Gateway è§£å†³çš„é—®é¢˜                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. å¤šæä¾›å•†ç»Ÿä¸€æ¥å£                                   â”‚
â”‚    - ä¸åŒ API æ ¼å¼ï¼ˆOpenAIã€Anthropicã€Geminiï¼‰       â”‚
â”‚    - åè®®å·®å¼‚å¤„ç†ï¼ˆsystem messagesã€tool callingï¼‰     â”‚
â”‚                                                      â”‚
â”‚ 2. é«˜å¯ç”¨æ€§ä¿éšœ                                       â”‚
â”‚    - è‡ªåŠ¨æ•…éšœæ£€æµ‹å’Œè½¬ç§»                               â”‚
â”‚    - å¤šå®ä¾‹è´Ÿè½½å‡è¡¡                                   â”‚
â”‚    - å¥åº·æ£€æŸ¥å’Œæ¢å¤                                   â”‚
â”‚                                                      â”‚
â”‚ 3. æ€§èƒ½ä¼˜åŒ–                                          â”‚
â”‚    - ç²˜æ€§ä¼šè¯ï¼ˆSession Affinityï¼‰                    â”‚
â”‚    - KV ç¼“å­˜å‘½ä¸­ç‡ä¼˜åŒ–                                â”‚
â”‚    - Prompt Caching è‡ªåŠ¨åŒ–                           â”‚
â”‚                                                      â”‚
â”‚ 4. è¿ç»´ç®€åŒ–                                          â”‚
â”‚    - é›¶å¤–éƒ¨ä¾èµ–ï¼ˆæ—  Redis/DBï¼‰                       â”‚
â”‚    - ç»Ÿä¸€çš„ç›‘æ§å’Œæ—¥å¿—                                 â”‚
â”‚    - ç®€å•çš„é…ç½®ç®¡ç†                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.3 ç›®æ ‡ç”¨æˆ·

- **AI åº”ç”¨å¼€å‘è€…**: éœ€è¦ç»Ÿä¸€æ¥å£è®¿é—®å¤šä¸ª LLM æä¾›å•†
- **ä¼ä¸š IT å›¢é˜Ÿ**: éœ€è¦é›†ä¸­ç®¡ç† API å¯†é’¥ã€ç›‘æ§å’Œæˆæœ¬æ§åˆ¶
- **å·¥å…·å¼€å‘è€…**: Cursorã€Claude Code ç­‰éœ€è¦ OpenAI å…¼å®¹æ¥å£çš„å·¥å…·
- **å¤šäº‘ç”¨æˆ·**: å¸Œæœ›åœ¨ä¸åŒäº‘å‚å•†çš„ LLM æœåŠ¡é—´çµæ´»åˆ‡æ¢

---

## 3. æ¶æ„åˆ†æ

### 3.1 æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      å®¢æˆ·ç«¯åº”ç”¨å±‚                              â”‚
â”‚  (Cursor, Claude Code, Custom Apps)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚ OpenAI Compatible API
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    LLM Gateway (Rust)                         â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚  Layer 1: HTTP/Auth (Axum + Middleware)                  â”‚ â”‚
â”‚ â”‚  - Bearer Token Authentication                           â”‚ â”‚
â”‚ â”‚  - Request Validation (10MB limit)                       â”‚ â”‚
â”‚ â”‚  - Tracing & Logging                                     â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚  Layer 2: Routing (ModelRouter)                          â”‚ â”‚
â”‚ â”‚  - Prefix-based routing (gpt-* â†’ OpenAI)                 â”‚ â”‚
â”‚ â”‚  - Model name validation                                 â”‚ â”‚
â”‚ â”‚  - Provider discovery                                    â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚  Layer 3: Load Balancing (Per-Provider LB)               â”‚ â”‚
â”‚ â”‚  - Sticky sessions (API key â†’ instance)                  â”‚ â”‚
â”‚ â”‚  - Priority-based selection                              â”‚ â”‚
â”‚ â”‚  - Health management                                     â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚  Layer 4: Protocol Conversion                            â”‚ â”‚
â”‚ â”‚  - OpenAI â†’ Anthropic converter                          â”‚ â”‚
â”‚ â”‚  - OpenAI â†’ Gemini converter                             â”‚ â”‚
â”‚ â”‚  - Response back-conversion                              â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚  Layer 5: Provider Clients                               â”‚ â”‚
â”‚ â”‚  - HTTP clients (reqwest)                                â”‚ â”‚
â”‚ â”‚  - Streaming support (SSE)                               â”‚ â”‚
â”‚ â”‚  - Retry & metrics                                       â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼                 â–¼                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  OpenAI API   â”‚ â”‚ Anthropic API â”‚ â”‚  Gemini API   â”‚
â”‚ (Primary/     â”‚ â”‚ (Primary/     â”‚ â”‚ (Primary/     â”‚
â”‚  Backup)      â”‚ â”‚  Backup)      â”‚ â”‚  Backup)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 è¯·æ±‚å¤„ç†æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Request Flow (è¯¦ç»†æ­¥éª¤)                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. HTTP Request
   â”œâ”€ Client â†’ POST /v1/chat/completions
   â”œâ”€ Headers: Authorization: Bearer sk-gateway-001
   â””â”€ Body: {"model": "claude-3-5-sonnet", "messages": [...]}

2. Auth Middleware (src/auth.rs)
   â”œâ”€ Extract Bearer token
   â”œâ”€ Validate against config.api_keys
   â”œâ”€ Attach AuthInfo to request extensions
   â””â”€ âœ… Pass to next layer OR âŒ 401 Unauthorized

3. ModelRouter (src/router.rs)
   â”œâ”€ Extract model name: "claude-3-5-sonnet"
   â”œâ”€ Prefix matching: "claude-" â†’ "anthropic"
   â”œâ”€ Check provider enabled
   â””â”€ Return RouteInfo {provider: Anthropic, requires_conversion: true}

4. LoadBalancer Selection (src/load_balancer.rs)
   â”œâ”€ Check session: sessions.get("sk-gateway-001")
   â”œâ”€ If exists & not expired & healthy â†’ reuse instance
   â”œâ”€ Else â†’ select_by_priority()
   â”‚   â”œâ”€ Filter: enabled && healthy
   â”‚   â”œâ”€ Find min_priority (e.g., priority=1)
   â”‚   â”œâ”€ Random among same priority
   â”‚   â””â”€ Create/update session (TTL: 1 hour)
   â””â”€ Return ProviderInstance {name: "anthropic-primary", config: {...}}

5. Protocol Conversion (src/converters/openai_to_anthropic.rs)
   â”œâ”€ Convert OpenAI request â†’ Anthropic request
   â”‚   â”œâ”€ Extract system message â†’ system field
   â”‚   â”œâ”€ Convert messages array
   â”‚   â”œâ”€ Add max_tokens (required for Anthropic)
   â”‚   â”œâ”€ Convert tools (OpenAI â†’ Anthropic format)
   â”‚   â””â”€ Apply prompt caching if enabled
   â””â”€ Generate conversion warnings (unsupported params)

6. Provider Client (src/providers/anthropic.rs)
   â”œâ”€ Build HTTP request
   â”‚   â”œâ”€ URL: base_url + "/messages"
   â”‚   â”œâ”€ Headers: x-api-key, anthropic-version
   â”‚   â”œâ”€ Body: converted request JSON
   â”‚   â””â”€ Timeout: instance.config.timeout_seconds
   â”œâ”€ Execute request (reqwest)
   â”œâ”€ Handle streaming if needed
   â””â”€ Parse response

7. Retry & Metrics (src/retry.rs)
   â”œâ”€ execute_with_session()
   â”œâ”€ On success:
   â”‚   â””â”€ record_instance_request(provider, instance, "success")
   â”œâ”€ On error:
   â”‚   â”œâ”€ is_instance_failure()?
   â”‚   â”œâ”€ Yes (5xx, timeout, connection) â†’
   â”‚   â”‚   â”œâ”€ mark_instance_failure()
   â”‚   â”‚   â”œâ”€ record_instance_request(..., "failure")
   â”‚   â”‚   â””â”€ Next request will failover
   â”‚   â””â”€ No (4xx, business error) â†’
   â”‚       â””â”€ record_instance_request(..., "business_error")
   â””â”€ Return result

8. Response Conversion (src/converters/anthropic_response.rs)
   â”œâ”€ Convert Anthropic response â†’ OpenAI response
   â”‚   â”œâ”€ Map role: "assistant" â†’ "assistant"
   â”‚   â”œâ”€ Convert content blocks
   â”‚   â”œâ”€ Map usage tokens
   â”‚   â””â”€ Convert tool calls if present
   â”œâ”€ Add X-LLM-Gateway-Warnings header if needed
   â””â”€ Return OpenAI-compatible response

9. HTTP Response
   â””â”€ Client â† 200 OK with OpenAI-formatted JSON
```

### 3.3 æ•°æ®æµå›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Data Structures & Flow                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Config (TOML) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                             â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ ArcSwap<Config>  â”‚ â† Hot reload support
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼                    â–¼                    â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Router  â”‚      â”‚ LoadBalancersâ”‚     â”‚ Auth Config  â”‚
   â”‚ Rules   â”‚      â”‚ (per provider)â”‚     â”‚ (API Keys)   â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  LoadBalancer State         â”‚
              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
              â”‚ sessions: DashMap           â”‚
              â”‚   â””â”€ "api-key" â†’ SessionInfoâ”‚
              â”‚       â”œâ”€ instance_name      â”‚
              â”‚       â””â”€ last_request_time  â”‚
              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
              â”‚ health_state: RwLock        â”‚
              â”‚   â””â”€ instances: HashMap     â”‚
              â”‚       â””â”€ "instance" â†’       â”‚
              â”‚           â”œâ”€ is_healthy     â”‚
              â”‚           â””â”€ last_failure   â”‚
              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
              â”‚ instances: Arc<Vec>         â”‚
              â”‚   â””â”€ ProviderInstance[]     â”‚
              â”‚       â”œâ”€ name: Arc<str>     â”‚
              â”‚       â””â”€ config: Enum       â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.4 æ¨¡å—ä¾èµ–å…³ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Module Dependency Graph                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

main.rs
  â””â”€> server.rs
       â”œâ”€> config.rs (Config, ProvidersConfig)
       â”œâ”€> auth.rs (auth_middleware)
       â”œâ”€> router.rs (ModelRouter, Provider)
       â”œâ”€> load_balancer.rs (LoadBalancer)
       â”œâ”€> handlers/
       â”‚    â”œâ”€> chat_completions.rs
       â”‚    â”‚    â”œâ”€> converters/ (protocol conversion)
       â”‚    â”‚    â”œâ”€> providers/ (API clients)
       â”‚    â”‚    â””â”€> retry.rs (execute_with_session)
       â”‚    â”œâ”€> messages.rs
       â”‚    â”œâ”€> models.rs
       â”‚    â””â”€> health.rs
       â”œâ”€> metrics.rs (Prometheus)
       â””â”€> signals.rs (SIGHUP, SIGTERM)

converters/
  â”œâ”€> openai_to_anthropic.rs
  â”‚    â””â”€> models/anthropic.rs
  â”œâ”€> openai_to_gemini.rs
  â”‚    â””â”€> models/gemini.rs
  â””â”€> anthropic_response.rs
       â””â”€> models/openai.rs (internal)

providers/
  â”œâ”€> anthropic.rs â†’ converters/
  â”œâ”€> gemini.rs â†’ converters/
  â””â”€> openai.rs (direct pass-through)

load_balancer.rs
  â”œâ”€> config.rs (ProviderInstanceConfig)
  â””â”€> metrics.rs (health metrics)

retry.rs
  â”œâ”€> load_balancer.rs (LoadBalancer)
  â”œâ”€> error.rs (AppError)
  â””â”€> metrics.rs (request metrics)

Shared Dependencies:
  - error.rs â† (everywhere)
  - models/ â† (converters, handlers)
  - metrics.rs â† (retry, load_balancer, handlers)
```

**å…³é”®è§‚å¯Ÿ**:
- âœ… ä¾èµ–å…³ç³»æ¸…æ™°ï¼Œæ— å¾ªç¯ä¾èµ–
- âœ… æ ¸å¿ƒæ¨¡å—ï¼ˆerror, config, metricsï¼‰è¢«å¹¿æ³›å¤ç”¨
- âœ… åè®®è½¬æ¢å±‚ä¸æä¾›å•†å±‚è§£è€¦è‰¯å¥½

---

## 4. ä»£ç ç»“æ„åˆ†æ

### 4.1 ç›®å½•ç»“æ„

```
llm-gateway/
â”œâ”€â”€ src/                           # æºä»£ç  (49 ä¸ª .rs æ–‡ä»¶)
â”‚   â”œâ”€â”€ handlers/                  # HTTP è¯·æ±‚å¤„ç†å±‚
â”‚   â”‚   â”œâ”€â”€ chat_completions.rs    # OpenAI å…¼å®¹ç«¯ç‚¹ (17KB, æ ¸å¿ƒé€»è¾‘)
â”‚   â”‚   â”œâ”€â”€ messages.rs            # åŸç”Ÿ Anthropic ç«¯ç‚¹
â”‚   â”‚   â”œâ”€â”€ models.rs              # æ¨¡å‹åˆ—è¡¨ç«¯ç‚¹
â”‚   â”‚   â”œâ”€â”€ health.rs              # å¥åº·æ£€æŸ¥
â”‚   â”‚   â””â”€â”€ metrics_handler.rs     # Prometheus ç«¯ç‚¹
â”‚   â”œâ”€â”€ converters/                # åè®®è½¬æ¢å±‚
â”‚   â”‚   â”œâ”€â”€ openai_to_anthropic.rs # OpenAI â†’ Anthropic (22KB)
â”‚   â”‚   â”œâ”€â”€ anthropic_response.rs  # Anthropic â†’ OpenAI (14KB)
â”‚   â”‚   â”œâ”€â”€ openai_to_gemini.rs    # OpenAI â†’ Gemini (14KB)
â”‚   â”‚   â”œâ”€â”€ gemini_response.rs     # Gemini â†’ OpenAI
â”‚   â”‚   â””â”€â”€ gemini_streaming.rs    # Gemini æµå¼è½¬æ¢
â”‚   â”œâ”€â”€ providers/                 # LLM æä¾›å•†å®¢æˆ·ç«¯
â”‚   â”‚   â”œâ”€â”€ anthropic.rs           # Anthropic API å®¢æˆ·ç«¯
â”‚   â”‚   â”œâ”€â”€ gemini.rs              # Gemini API å®¢æˆ·ç«¯
â”‚   â”‚   â””â”€â”€ openai.rs              # OpenAI API å®¢æˆ·ç«¯
â”‚   â”œâ”€â”€ models/                    # æ•°æ®æ¨¡å‹å®šä¹‰
â”‚   â”‚   â”œâ”€â”€ anthropic.rs           # Anthropic è¯·æ±‚/å“åº”æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ gemini.rs              # Gemini è¯·æ±‚/å“åº”æ¨¡å‹
â”‚   â”‚   â””â”€â”€ openai.rs              # OpenAI è¯·æ±‚/å“åº”æ¨¡å‹
â”‚   â”œâ”€â”€ load_balancer.rs           # è´Ÿè½½å‡è¡¡å™¨ (406 è¡Œ)
â”‚   â”œâ”€â”€ retry.rs                   # é‡è¯•å’Œæ•…éšœæ£€æµ‹ (196 è¡Œ)
â”‚   â”œâ”€â”€ router.rs                  # æ¨¡å‹è·¯ç”± (340 è¡Œ)
â”‚   â”œâ”€â”€ auth.rs                    # è®¤è¯ä¸­é—´ä»¶ (240 è¡Œ)
â”‚   â”œâ”€â”€ metrics.rs                 # Prometheus æŒ‡æ ‡ (177 è¡Œ)
â”‚   â”œâ”€â”€ config.rs                  # é…ç½®ç®¡ç†
â”‚   â”œâ”€â”€ error.rs                   # é”™è¯¯ç±»å‹å®šä¹‰ (138 è¡Œ)
â”‚   â”œâ”€â”€ server.rs                  # æœåŠ¡å™¨å¯åŠ¨é€»è¾‘
â”‚   â”œâ”€â”€ signals.rs                 # ä¿¡å·å¤„ç† (SIGHUP, SIGTERM)
â”‚   â”œâ”€â”€ streaming.rs               # SSE æµå¼å“åº”
â”‚   â”œâ”€â”€ image_utils.rs             # å›¾åƒå¤„ç†å·¥å…·
â”‚   â”œâ”€â”€ conversion_warnings.rs     # åè®®è½¬æ¢è­¦å‘Š
â”‚   â”œâ”€â”€ stats.rs                   # ç»Ÿè®¡ä»ªè¡¨ç›˜
â”‚   â”œâ”€â”€ pid.rs                     # PID æ–‡ä»¶ç®¡ç†
â”‚   â”œâ”€â”€ lib.rs                     # åº“å…¥å£
â”‚   â””â”€â”€ main.rs                    # ç¨‹åºå…¥å£
â”œâ”€â”€ tests/                         # é›†æˆæµ‹è¯• (6 ä¸ªæµ‹è¯•æ–‡ä»¶)
â”‚   â”œâ”€â”€ multimodal_tests.rs        # å¤šæ¨¡æ€åŠŸèƒ½æµ‹è¯•
â”‚   â”œâ”€â”€ tool_calling_tests.rs      # å·¥å…·è°ƒç”¨æµ‹è¯•
â”‚   â”œâ”€â”€ json_mode_tests.rs         # JSON æ¨¡å¼æµ‹è¯•
â”‚   â””â”€â”€ caching_tests.rs           # Prompt Caching æµ‹è¯•
â”œâ”€â”€ examples/                      # ç¤ºä¾‹ä»£ç  (8 ä¸ªç¤ºä¾‹)
â”‚   â”œâ”€â”€ vision_example.rs
â”‚   â”œâ”€â”€ tool_calling_example.rs
â”‚   â”œâ”€â”€ json_mode_example.rs
â”‚   â””â”€â”€ caching_example.rs
â”œâ”€â”€ docs/                          # æ–‡æ¡£
â”‚   â”œâ”€â”€ FEATURES.md
â”‚   â””â”€â”€ CONVERSION_LIMITATIONS.md
â”œâ”€â”€ Cargo.toml                     # ä¾èµ–é…ç½®
â”œâ”€â”€ Dockerfile                     # Docker é•œåƒ
â”œâ”€â”€ config.toml.example            # é…ç½®ç¤ºä¾‹
â”œâ”€â”€ README.md                      # é¡¹ç›®æ–‡æ¡£ (628 è¡Œ)
â”œâ”€â”€ CLAUDE.md                      # å¼€å‘æŒ‡å— (è¯¦ç»†)
â””â”€â”€ CODE_REVIEW.md                 # ä»£ç å®¡æŸ¥æŠ¥å‘Š

ç»Ÿè®¡ä¿¡æ¯:
- æºä»£ç æ–‡ä»¶: 49 ä¸ª .rs æ–‡ä»¶
- æ€»ä»£ç è¡Œæ•°: ~111,000 è¡Œ (åŒ…æ‹¬æ³¨é‡Šå’Œç©ºè¡Œ)
- å®é™…ä»£ç : ~9,760 è¡Œ (ä¸»è¦ä¸šåŠ¡é€»è¾‘)
- æµ‹è¯•ä»£ç : ~6 ä¸ªé›†æˆæµ‹è¯•æ–‡ä»¶
- ç¤ºä¾‹ä»£ç : 8 ä¸ªå¯è¿è¡Œç¤ºä¾‹
```

### 4.2 æ ¸å¿ƒæ¨¡å—ä»£ç è§„æ¨¡

| æ¨¡å— | æ–‡ä»¶ | è¡Œæ•° | èŒè´£ | å¤æ‚åº¦ |
|-----|------|------|------|--------|
| **handlers/chat_completions** | chat_completions.rs | 571 | æ ¸å¿ƒè¯·æ±‚å¤„ç† | é«˜ |
| **converters/openai_to_anthropic** | openai_to_anthropic.rs | 753 | åè®®è½¬æ¢æ ¸å¿ƒ | é«˜ |
| **converters/anthropic_response** | anthropic_response.rs | 479 | å“åº”è½¬æ¢ | ä¸­ |
| **converters/openai_to_gemini** | openai_to_gemini.rs | 475 | Gemini è½¬æ¢ | ä¸­ |
| **load_balancer** | load_balancer.rs | 406 | è´Ÿè½½å‡è¡¡é€»è¾‘ | ä¸­ |
| **router** | router.rs | 340 | è·¯ç”±é€»è¾‘ | ä½ |
| **auth** | auth.rs | 240 | è®¤è¯ä¸­é—´ä»¶ | ä½ |
| **retry** | retry.rs | 196 | æ•…éšœæ£€æµ‹ | ä¸­ |
| **metrics** | metrics.rs | 177 | æŒ‡æ ‡æ”¶é›† | ä½ |
| **error** | error.rs | 138 | é”™è¯¯å®šä¹‰ | ä½ |

**ä»£ç è´¨é‡è§‚å¯Ÿ**:
- âœ… å•ä¸ªæ–‡ä»¶ä¸è¶…è¿‡ 800 è¡Œï¼Œæ¨¡å—åŒ–è‰¯å¥½
- âœ… æ ¸å¿ƒé€»è¾‘é›†ä¸­åœ¨ `handlers/chat_completions` å’Œ `converters/`
- âœ… å¹³å‡å‡½æ•°é•¿åº¦è¾ƒçŸ­ï¼Œå¯è¯»æ€§å¥½
- âš ï¸ `converters/` ç›®å½•ä»£ç é‡è¾ƒå¤§ï¼Œæœªæ¥å¯èƒ½éœ€è¦è¿›ä¸€æ­¥æ‹†åˆ†

### 4.3 æµ‹è¯•è¦†ç›–æƒ…å†µ

```
æµ‹è¯•ç±»å‹åˆ†å¸ƒ:

1. å•å…ƒæµ‹è¯• (åµŒå…¥åœ¨æºæ–‡ä»¶ä¸­)
   â”œâ”€ load_balancer.rs       âœ… 3 ä¸ªæµ‹è¯•
   â”œâ”€ retry.rs               âœ… 3 ä¸ªæµ‹è¯•
   â”œâ”€ router.rs              âœ… 11 ä¸ªæµ‹è¯•
   â”œâ”€ error.rs               âœ… 3 ä¸ªæµ‹è¯•
   â”œâ”€ auth.rs                âš ï¸ 3 ä¸ªæµ‹è¯• (marked #[ignore])
   â””â”€ metrics.rs             âœ… 1 ä¸ªæµ‹è¯•

2. é›†æˆæµ‹è¯• (tests/ ç›®å½•)
   â”œâ”€ multimodal_tests.rs    âœ… è§†è§‰/å›¾åƒåŠŸèƒ½
   â”œâ”€ tool_calling_tests.rs  âœ… å·¥å…·è°ƒç”¨
   â”œâ”€ json_mode_tests.rs     âœ… JSON æ¨¡å¼
   â”œâ”€ caching_tests.rs       âœ… Prompt Caching
   â””â”€ health_tests.rs        âœ… å¥åº·æ£€æŸ¥

3. ç¤ºä¾‹ä»£ç  (examples/ ç›®å½•)
   â”œâ”€ vision_example.rs
   â”œâ”€ tool_calling_example.rs
   â”œâ”€ json_mode_example.rs
   â”œâ”€ caching_example.rs
   â””â”€ 4 ä¸ªå…¶ä»–ç¤ºä¾‹

æµ‹è¯•è¦†ç›–ç‡ä¼°è®¡:
- å•å…ƒæµ‹è¯•è¦†ç›–: ~65% (æ ¸å¿ƒé€»è¾‘æœ‰æµ‹è¯•)
- é›†æˆæµ‹è¯•è¦†ç›–: ~50% (ä¸»è¦åŠŸèƒ½æœ‰æµ‹è¯•)
- ç¼ºå¤±: æ€§èƒ½åŸºå‡†æµ‹è¯•ã€å‹åŠ›æµ‹è¯•ã€ç«¯åˆ°ç«¯æµ‹è¯•
```

---

## 5. æŠ€æœ¯æ ˆä¸ä¾èµ–

### 5.1 æ ¸å¿ƒæŠ€æœ¯æ ˆ

| æŠ€æœ¯é¢†åŸŸ | é€‰å‹ | ç‰ˆæœ¬ | åŸå›  |
|---------|------|------|------|
| **ç¼–ç¨‹è¯­è¨€** | Rust | 2021 edition | é«˜æ€§èƒ½ã€å†…å­˜å®‰å…¨ã€å¹¶å‘å‹å¥½ |
| **Web æ¡†æ¶** | Axum | 0.7 | ç°ä»£åŒ–ã€ç±»å‹å®‰å…¨ã€æ€§èƒ½ä¼˜å¼‚ |
| **å¼‚æ­¥è¿è¡Œæ—¶** | Tokio | 1.x | æˆç†Ÿçš„å¼‚æ­¥ç”Ÿæ€ï¼Œå·¥ä¸šçº§ç¨³å®šæ€§ |
| **HTTP å®¢æˆ·ç«¯** | reqwest | 0.12 | åŠŸèƒ½å®Œå–„ï¼Œæ”¯æŒæµå¼ã€è¿æ¥æ±  |
| **åºåˆ—åŒ–** | serde + serde_json | 1.0 | Rust æ ‡å‡†åºåˆ—åŒ–åº“ |
| **å¹¶å‘æ•°æ®ç»“æ„** | DashMap | 6.0 | é«˜æ€§èƒ½å¹¶å‘å“ˆå¸Œè¡¨ï¼Œåˆ†æ®µé” |
| **é…ç½®ç®¡ç†** | toml | 0.8 | äººç±»å‹å¥½çš„é…ç½®æ ¼å¼ |
| **æŒ‡æ ‡** | metrics + prometheus | 0.23/0.15 | æ ‡å‡† Prometheus æŒ‡æ ‡ |
| **æ—¥å¿—è¿½è¸ª** | tracing | 0.1 | ç»“æ„åŒ–æ—¥å¿—ï¼Œæ€§èƒ½ä¼˜å¼‚ |
| **é”™è¯¯å¤„ç†** | thiserror + anyhow | 2.0/1.0 | æƒ¯ç”¨çš„ Rust é”™è¯¯å¤„ç† |

### 5.2 ä¾èµ–åˆ†æ

#### æ ¸å¿ƒä¾èµ– (27 ä¸ªç›´æ¥ä¾èµ–)

```toml
[dependencies]
# Web æœåŠ¡æ ¸å¿ƒ
axum = { version = "0.7", features = ["macros"] }
tokio = { version = "1", features = ["full"] }
tower = "0.5"                                   # ä¸­é—´ä»¶æ”¯æŒ
tower-http = { version = "0.6", features = ["trace", "cors"] }

# HTTP å®¢æˆ·ç«¯
reqwest = { version = "0.12", features = ["json", "stream"] }

# åºåˆ—åŒ–
serde = { version = "1.0", features = ["derive"] }
serde_json = "1.0"
toml = "0.8"
base64 = "0.22"                                 # å›¾åƒç¼–ç 

# CLI & è¿›ç¨‹ç®¡ç†
clap = { version = "4.5", features = ["derive", "cargo", "env"] }
daemonize = "0.5"                               # å®ˆæŠ¤è¿›ç¨‹
fs2 = "0.4"                                     # æ–‡ä»¶é” (PID)
colored = "2.1"                                 # ç»ˆç«¯å½©è‰²è¾“å‡º
arc-swap = "1.7"                                # åŸå­é…ç½®äº¤æ¢
nix = { version = "0.27", features = ["signal"] }  # ä¿¡å·å¤„ç†

# æ—¥å¿—è¿½è¸ª
tracing = "0.1"
tracing-subscriber = { version = "0.3", features = ["json", "env-filter"] }

# æŒ‡æ ‡
metrics = "0.23"
metrics-exporter-prometheus = "0.15"

# Token è®¡æ•°
tiktoken-rs = "0.5"                             # OpenAI åˆ†è¯å™¨

# é”™è¯¯å¤„ç†
thiserror = "2.0"
anyhow = "1.0"

# å¼‚æ­¥æµ
futures = "0.3"
futures-util = "0.3"

# å¹¶å‘ & éšæœº
dashmap = "6.0"                                 # å¹¶å‘å“ˆå¸Œè¡¨
rand = "0.8"                                    # éšæœºæ•°ç”Ÿæˆ

# SSE æµå¼
eventsource-stream = "0.2"                      # SSE è§£æ

# TUI & ç»Ÿè®¡
ratatui = "0.28"                                # ç»ˆç«¯ UI
crossterm = "0.28"                              # è·¨å¹³å°ç»ˆç«¯
prometheus-parse = "0.2"                        # Prometheus è§£æ

# å…¶ä»–
chrono = "0.4"                                  # æ—¶é—´å¤„ç†
uuid = { version = "1.11", features = ["v4"] }  # UUID ç”Ÿæˆ

[dev-dependencies]
httpmock = "0.8"                                # HTTP æ¨¡æ‹Ÿæµ‹è¯•
```

#### ä¾èµ–å¥åº·åº¦è¯„ä¼°

| ä¾èµ– | è¯„çº§ | è¯´æ˜ |
|-----|------|------|
| axum | â­â­â­â­â­ | æ´»è·ƒç»´æŠ¤ï¼Œç¤¾åŒºå¹¿æ³›ä½¿ç”¨ |
| tokio | â­â­â­â­â­ | Rust å¼‚æ­¥æ ‡å‡†ï¼Œæå…¶æˆç†Ÿ |
| reqwest | â­â­â­â­â­ | HTTP å®¢æˆ·ç«¯é¦–é€‰ï¼ŒåŠŸèƒ½å®Œå–„ |
| dashmap | â­â­â­â­ | é«˜æ€§èƒ½å¹¶å‘åº“ï¼Œç»´æŠ¤æ´»è·ƒ |
| serde | â­â­â­â­â­ | Rust åºåˆ—åŒ–æ ‡å‡† |
| tracing | â­â­â­â­â­ | æ—¥å¿—è¿½è¸ªæ ‡å‡†åº“ |
| config | âš ï¸â­â­â­ | ä½¿ç”¨åº¦ä½ï¼Œå¯èƒ½å¯ä»¥ç§»é™¤ |
| arc-swap | â­â­â­â­ | ä¸“ç”¨åº“ï¼ŒåŠŸèƒ½å•ä¸€ä½†æœ‰æ•ˆ |

**æ½œåœ¨é—®é¢˜**:
- âš ï¸ `config = "0.14"` ä¾èµ–ä¼¼ä¹æœªå……åˆ†ä½¿ç”¨ï¼ˆä¸»è¦é€šè¿‡ `toml` å’Œ `serde`ï¼‰
- âœ… æ‰€æœ‰ä¾èµ–éƒ½æ˜¯ä¸»æµåº“ï¼Œä¾›åº”é“¾é£é™©ä½
- âœ… æ— è¿‡æ—¶æˆ–åºŸå¼ƒçš„ä¾èµ–

### 5.3 ç¼–è¯‘é…ç½®

```toml
[profile.release]
opt-level = 3          # æœ€å¤§ä¼˜åŒ–
lto = true             # é“¾æ¥æ—¶ä¼˜åŒ–
codegen-units = 1      # å•ä¸ªä»£ç ç”Ÿæˆå•å…ƒ (æœ€å¤§ä¼˜åŒ–)
strip = true           # ç§»é™¤ç¬¦å·è¡¨ (å‡å°äºŒè¿›åˆ¶å¤§å°)
```

**æ€§èƒ½å½±å“**:
- âœ… å‘å¸ƒç‰ˆæœ¬ç¼–è¯‘æ—¶é—´è¾ƒé•¿ï¼Œä½†è¿è¡Œæ—¶æ€§èƒ½æœ€ä¼˜
- âœ… äºŒè¿›åˆ¶ä½“ç§¯è¾ƒå°ï¼ˆstrip ç§»é™¤è°ƒè¯•ç¬¦å·ï¼‰
- âœ… LTO ä¼˜åŒ–è·¨ crate å‡½æ•°è°ƒç”¨

---

## 6. æ ¸å¿ƒåŠŸèƒ½ç‰¹æ€§

### 6.1 åŠŸèƒ½çŸ©é˜µ

| åŠŸèƒ½ç±»åˆ« | åŠŸèƒ½ç‚¹ | æ”¯æŒçŠ¶æ€ | å®ç°è´¨é‡ | è¯´æ˜ |
|---------|--------|----------|----------|------|
| **API å…¼å®¹æ€§** | | | | |
| - OpenAI å…¼å®¹ API | âœ… | â­â­â­â­â­ | å®Œå…¨å…¼å®¹ `/v1/chat/completions` |
| - Anthropic åŸç”Ÿ API | âœ… | â­â­â­â­ | æ”¯æŒ `/v1/messages` ç«¯ç‚¹ |
| - æ¨¡å‹åˆ—è¡¨ API | âœ… | â­â­â­â­ | `/v1/models` åŠ¨æ€å‘ç° |
| **åè®®è½¬æ¢** | | | | |
| - OpenAI â†’ Anthropic | âœ… | â­â­â­â­â­ | å®Œæ•´è½¬æ¢ï¼ŒåŒ…æ‹¬ toolsã€vision |
| - OpenAI â†’ Gemini | âœ… | â­â­â­â­ | å®Œæ•´è½¬æ¢ |
| - Anthropic â†’ OpenAI | âœ… | â­â­â­â­ | å“åº”æ ¼å¼è½¬æ¢ |
| - è½¬æ¢è­¦å‘Š | âœ… | â­â­â­â­ | HTTP header è­¦å‘Š |
| **æµå¼å“åº”** | | | | |
| - OpenAI SSE | âœ… | â­â­â­â­â­ | å®Œæ•´æµå¼æ”¯æŒ |
| - Anthropic SSE | âœ… | â­â­â­â­â­ | å®æ—¶åè®®è½¬æ¢ |
| - Gemini SSE | âœ… | â­â­â­â­ | æµå¼è½¬æ¢ |
| - å¢é‡ JSON ç»„è£… | âœ… | â­â­â­â­ | å·¥å…·è°ƒç”¨æµå¼æ”¯æŒ |
| **å¤šæ¨¡æ€** | | | | |
| - æ–‡æœ¬å¯¹è¯ | âœ… | â­â­â­â­â­ | å…¨æ”¯æŒ |
| - è§†è§‰/å›¾åƒ | âœ… | â­â­â­â­â­ | Base64 è‡ªåŠ¨è½¬æ¢ |
| - å·¥å…·è°ƒç”¨ | âœ… | â­â­â­â­â­ | éæµå¼ + æµå¼ |
| - JSON æ¨¡å¼ | âœ… | â­â­â­â­ | åŸç”Ÿ + ç³»ç»Ÿæç¤ºæ³¨å…¥ |
| - JSON Schema | âœ… | â­â­â­â­ | ä¸¥æ ¼æ¨¡å¼æ”¯æŒ |
| **è´Ÿè½½å‡è¡¡** | | | | |
| - å¤šå®ä¾‹æ”¯æŒ | âœ… | â­â­â­â­â­ | æ¯ä¸ªæä¾›å•†å¤šå®ä¾‹ |
| - ä¼˜å…ˆçº§é€‰æ‹© | âœ… | â­â­â­â­â­ | Priority-based |
| - ç²˜æ€§ä¼šè¯ | âœ… | â­â­â­â­â­ | API key â†’ instance ç»‘å®š |
| - æƒé‡è´Ÿè½½å‡è¡¡ | âŒ | - | ç¼ºå¤±ï¼ˆæœªæ¥æ”¹è¿›ï¼‰ |
| **é«˜å¯ç”¨æ€§** | | | | |
| - å¥åº·æ£€æŸ¥ | âœ… | â­â­â­â­ | è¢«åŠ¨æ—¶é—´æ£€æµ‹ |
| - è‡ªåŠ¨æ•…éšœè½¬ç§» | âœ… | â­â­â­â­â­ | å•æ¬¡å¤±è´¥è§¦å‘ |
| - è‡ªåŠ¨æ¢å¤ | âœ… | â­â­â­ | åŸºäºæ—¶é—´ï¼Œå¾…ä¼˜åŒ– |
| - ä¸»åŠ¨å¥åº·æ¢æµ‹ | âŒ | - | ç¼ºå¤±ï¼ˆå¾…å®ç°ï¼‰ |
| **æ€§èƒ½ä¼˜åŒ–** | | | | |
| - Prompt Caching | âœ… | â­â­â­â­â­ | Anthropic è‡ªåŠ¨ç¼“å­˜ |
| - KV Cache ä¼˜åŒ– | âœ… | â­â­â­â­â­ | é€šè¿‡ç²˜æ€§ä¼šè¯ |
| - è¿æ¥æ±  | âœ… | â­â­â­â­ | reqwest é»˜è®¤æ±  |
| - è¯·æ±‚è¶…æ—¶æ§åˆ¶ | âš ï¸ | â­â­â­ | é…ç½®çº§ï¼Œç¼ºå°‘è¯·æ±‚çº§ |
| **ç›‘æ§** | | | | |
| - Prometheus æŒ‡æ ‡ | âœ… | â­â­â­â­ | 4 ç»´åº¦æŒ‡æ ‡ |
| - å®ä¾‹çº§æŒ‡æ ‡ | âœ… | â­â­â­â­â­ | å¥åº·çŠ¶æ€ã€è¯·æ±‚æ•° |
| - ç»“æ„åŒ–æ—¥å¿— | âœ… | â­â­â­â­ | JSON æ ¼å¼ |
| - åˆ†å¸ƒå¼è¿½è¸ª | âŒ | - | ç¼ºå¤±ï¼ˆæœªæ¥ï¼‰ |
| **å®‰å…¨æ€§** | | | | |
| - API Key è®¤è¯ | âœ… | â­â­â­â­ | Bearer token |
| - è¾“å…¥éªŒè¯ | âœ… | â­â­â­â­ | æ¨¡å‹åéªŒè¯ |
| - è¯·æ±‚å¤§å°é™åˆ¶ | âœ… | â­â­â­â­ | 10MB é™åˆ¶ |
| - Rate Limiting | âŒ | - | ç¼ºå¤±ï¼ˆé‡è¦ï¼‰ |
| - TLS/HTTPS | âš ï¸ | â­â­â­ | ä¾èµ–åå‘ä»£ç† |
| **è¿ç»´** | | | | |
| - é…ç½®çƒ­é‡è½½ | âœ… | â­â­â­ | SIGHUP è§¦å‘ |
| - ä¼˜é›…å…³é—­ | âœ… | â­â­â­â­â­ | SIGTERM æ”¯æŒ |
| - Docker éƒ¨ç½² | âœ… | â­â­â­â­ | å®˜æ–¹ Dockerfile |
| - å¥åº·æ£€æŸ¥ç«¯ç‚¹ | âœ… | â­â­â­â­ | /health, /ready |
| - å®ˆæŠ¤è¿›ç¨‹æ¨¡å¼ | âœ… | â­â­â­â­ | æ”¯æŒ daemon æ¨¡å¼ |

**æ€»è®¡**:
- âœ… å·²å®ç°: 38 ä¸ª
- âš ï¸ éƒ¨åˆ†å®ç°: 3 ä¸ª
- âŒ ç¼ºå¤±: 5 ä¸ª

### 6.2 åè®®è½¬æ¢è¯¦è§£

#### OpenAI â†’ Anthropic è½¬æ¢é€»è¾‘

```rust
ä¸»è¦è½¬æ¢ç‚¹ (src/converters/openai_to_anthropic.rs):

1. System Message æå–
   OpenAI:  messages[0] = {role: "system", content: "..."}
   â†“
   Anthropic: system = "..."  (ç‹¬ç«‹å­—æ®µ)

2. Role æ˜ å°„
   OpenAI:  "assistant" â†’ Anthropic: "assistant"
   OpenAI:  "user"      â†’ Anthropic: "user"
   (ç›¸åŒï¼Œæ— éœ€è½¬æ¢)

3. max_tokens å¤„ç†
   OpenAI:  max_tokens (å¯é€‰)
   â†“
   Anthropic: max_tokens (å¿…éœ€ï¼Œé»˜è®¤ 4096)

4. temperature èŒƒå›´
   OpenAI:  0-2
   â†“
   Anthropic: 0-1 (è‡ªåŠ¨è£å‰ª)

5. Tools è½¬æ¢
   OpenAI:  tools: [{type: "function", function: {...}}]
   â†“
   Anthropic: tools: [{name: "...", input_schema: {...}}]

6. å›¾åƒå¤„ç†
   OpenAI:  image_url.url = "data:image/jpeg;base64,..."
   â†“
   Anthropic: source.data = "..." (æå– base64)

7. Prompt Caching (è‡ªåŠ¨åŒ–)
   - æ£€æµ‹ system prompt tokens â‰¥ 1024
   - è‡ªåŠ¨æ·»åŠ  cache_control: {type: "ephemeral"}
   - åœ¨æœ€åä¸€ä¸ª tool ä¸Šæ ‡è®°ç¼“å­˜

8. ä¸æ”¯æŒçš„å‚æ•° (ç”Ÿæˆè­¦å‘Š)
   - seed â†’ è­¦å‘Š
   - logprobs â†’ è­¦å‘Š
   - logit_bias â†’ è­¦å‘Š
   - response_format (JSON mode) â†’ ç³»ç»Ÿæç¤ºæ³¨å…¥
```

#### Anthropic â†’ OpenAI å“åº”è½¬æ¢

```rust
å“åº”è½¬æ¢ (src/converters/anthropic_response.rs):

1. Content Blocks è½¬æ¢
   Anthropic: content: [{type: "text", text: "..."}]
   â†“
   OpenAI: message.content = "..."  (åˆå¹¶æ–‡æœ¬)

2. Tool Calls è½¬æ¢
   Anthropic: content: [{type: "tool_use", id, name, input}]
   â†“
   OpenAI: tool_calls: [{id, function: {name, arguments}}]

3. Usage æ˜ å°„
   Anthropic: usage: {input_tokens, output_tokens}
   â†“
   OpenAI: usage: {prompt_tokens, completion_tokens, total_tokens}

4. æµå¼è½¬æ¢
   Anthropic: event: content_block_delta {delta: {text: "..."}}
   â†“
   OpenAI: data: {choices: [{delta: {content: "..."}}]}

5. Stop Reason æ˜ å°„
   Anthropic: "end_turn" â†’ OpenAI: "stop"
   Anthropic: "tool_use" â†’ OpenAI: "tool_calls"
   Anthropic: "max_tokens" â†’ OpenAI: "length"
```

### 6.3 Prompt Caching è‡ªåŠ¨åŒ–

```rust
è‡ªåŠ¨ç¼“å­˜ç­–ç•¥ (config.toml):

[providers.anthropic.cache]
auto_cache_system = true       # è‡ªåŠ¨ç¼“å­˜ system prompt
min_system_tokens = 1024       # æœ€å° tokens è§¦å‘é˜ˆå€¼
auto_cache_tools = true        # è‡ªåŠ¨ç¼“å­˜ tool definitions

å®ç°é€»è¾‘:
1. è®¡ç®— system prompt tokens (ä½¿ç”¨ tiktoken-rs)
2. å¦‚æœ tokens â‰¥ 1024:
   - å°† string â†’ blocks æ ¼å¼
   - åœ¨æœ€åä¸€ä¸ª block æ·»åŠ  cache_control
3. å¦‚æœæœ‰ tools:
   - åœ¨æœ€åä¸€ä¸ª tool æ·»åŠ  cache_control

æˆæœ¬èŠ‚çº¦:
- ç¼“å­˜å‘½ä¸­: 10% æˆæœ¬ (90% æŠ˜æ‰£)
- ç¼“å­˜å†™å…¥: 125% æˆæœ¬ (ä¸€æ¬¡æ€§)
- é•¿å¯¹è¯åœºæ™¯: æ˜¾è‘—èŠ‚çº¦
```

---

## 7. æ€§èƒ½ä¸å¹¶å‘è®¾è®¡

### 7.1 å¹¶å‘æ¨¡å‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Concurrency Architecture                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Tokio è¿è¡Œæ—¶ (å¤šçº¿ç¨‹)
    â”œâ”€ å·¥ä½œçº¿ç¨‹æ±  (é»˜è®¤: CPU æ ¸å¿ƒæ•°)
    â”œâ”€ I/O çº¿ç¨‹æ±  (ç”¨äºæ–‡ä»¶ I/O)
    â””â”€ å®šæ—¶å™¨çº¿ç¨‹

æ¯ä¸ªè¯·æ±‚: ç‹¬ç«‹çš„ async task
    â”œâ”€ Auth middleware (å…±äº« Arc<Config>)
    â”œâ”€ Router (å…±äº« Arc<ModelRouter>)
    â”œâ”€ LoadBalancer selection
    â”‚   â”œâ”€ Session lookup (DashMap::get)  â† é«˜å¹¶å‘è¯»
    â”‚   â”œâ”€ Health check (RwLock::read)    â† è¯»é”
    â”‚   â””â”€ Session update (DashMap::insert)
    â”œâ”€ HTTP request (reqwest å¼‚æ­¥)
    â””â”€ Response streaming (futures::Stream)

åå°ä»»åŠ¡ (per provider):
    â”œâ”€ health_recovery_loop()
    â”‚   â””â”€ æ¯ 10 ç§’æ£€æŸ¥ä¸€æ¬¡
    â””â”€ session_cleanup_loop()
        â””â”€ æ¯ 5 åˆ†é’Ÿæ¸…ç†ä¸€æ¬¡

å¹¶å‘ç‰¹æ€§:
- âœ… æ— é”æ•°æ®ç»“æ„ (DashMap åˆ†æ®µé”)
- âœ… è¯»å†™é”ä¼˜åŒ– (RwLock ç”¨äºè¯»å¤šå†™å°‘)
- âœ… Arc å…±äº«ä¸å¯å˜æ•°æ®
- âœ… æ— å…¨å±€äº’æ–¥é” (global mutex)
```

### 7.2 é”ç­–ç•¥åˆ†æ

| æ•°æ®ç»“æ„ | é”ç±»å‹ | å¹¶å‘ç‰¹æ€§ | æ€§èƒ½å½±å“ |
|---------|--------|----------|----------|
| `sessions: DashMap` | åˆ†æ®µé” | é«˜å¹¶å‘è¯»å†™ | â­â­â­â­â­ æä½äº‰ç”¨ |
| `health_state: RwLock` | è¯»å†™é” | è¯»å¤šå†™å°‘ | â­â­â­â­â­ è¯»æ— äº‰ç”¨ |
| `instances: Arc<Vec>` | æ— é” | ä¸å¯å˜ | â­â­â­â­â­ é›¶å¼€é”€ |
| `config: ArcSwap` | åŸå­äº¤æ¢ | è¯»æé¢‘ç¹ | â­â­â­â­â­ å‡ ä¹æ— å¼€é”€ |

**æ€§èƒ½ä¼˜åŠ¿**:
1. **DashMap**: å°†å“ˆå¸Œè¡¨åˆ†æˆå¤šä¸ªæ®µï¼Œæ¯ä¸ªæ®µç‹¬ç«‹é”å®šï¼Œé™ä½é”äº‰ç”¨
2. **RwLock**: å…è®¸å¤šä¸ªè¯»è€…åŒæ—¶è®¿é—®ï¼Œåªåœ¨å†™æ—¶é˜»å¡
3. **ArcSwap**: åŸå­æŒ‡é’ˆäº¤æ¢ï¼Œè¯»æ“ä½œåªéœ€è¦ä¸€æ¬¡åŸå­åŠ è½½

### 7.3 å†…å­˜ç®¡ç†

```rust
å†…å­˜ä¼˜åŒ–ç­–ç•¥:

1. Arc å…±äº«
   - Config: Arc<Config> é¿å…å…‹éš†
   - ProviderInstance::name: Arc<str> (ä¸æ˜¯ String)
   - å‡å°‘å†…å­˜åˆ†é…

2. é›¶æ‹·è´
   - æµå¼å“åº”: Stream<Item = Bytes> ç›´æ¥ä¼ è¾“
   - reqwest è¿æ¥æ± å¤ç”¨

3. ä¼šè¯æ¸…ç†
   - æ¯ 5 åˆ†é’Ÿæ¸…ç†è¿‡æœŸä¼šè¯
   - é¿å…å†…å­˜æ³„æ¼

4. å›ºå®šå¤§å°é™åˆ¶
   - è¯·æ±‚ä½“: 10MB é™åˆ¶
   - é˜²æ­¢å†…å­˜è€—å°½æ”»å‡»

ä¼°è®¡å†…å­˜å ç”¨ (1000 å¹¶å‘è¯·æ±‚):
- åŸºç¡€å¼€é”€: ~50MB
- æ¯ä¸ªä¼šè¯: ~1KB
- 1000 ä¸ªä¼šè¯: ~1MB
- HTTP è¿æ¥æ± : ~20MB
- æ€»è®¡: ~100-150MB
```

### 7.4 æ€§èƒ½åŸºå‡†ä¼°ç®—

```
ç†è®ºæ€§èƒ½åˆ†æ:

ç“¶é¢ˆè¯†åˆ«:
1. âŒ ç½‘ç»œ I/O (æœ€å¤§ç“¶é¢ˆ) - ä¸Šæ¸¸ API å»¶è¿Ÿ
2. âš ï¸ åè®®è½¬æ¢ - JSON åºåˆ—åŒ–/ååºåˆ—åŒ–
3. âœ… è·¯ç”±é€‰æ‹© - å“ˆå¸Œè¡¨æŸ¥æ‰¾ (O(1))
4. âœ… è´Ÿè½½å‡è¡¡ - å†…å­˜è®¿é—® (çº³ç§’çº§)

ä¼°è®¡å»¶è¿Ÿ (å•æ¬¡è¯·æ±‚):
- ç½‘å…³å†…éƒ¨å¤„ç†: <5ms
  â”œâ”€ Auth: <0.5ms (å“ˆå¸Œè¡¨æŸ¥æ‰¾)
  â”œâ”€ Routing: <0.1ms (å‰ç¼€åŒ¹é…)
  â”œâ”€ LB selection: <0.5ms (å†…å­˜æŸ¥æ‰¾)
  â”œâ”€ Protocol conversion: <3ms (JSON å¤„ç†)
  â””â”€ Response conversion: <1ms
- ä¸Šæ¸¸ API è°ƒç”¨: 500-3000ms (å–å†³äºæä¾›å•†)
- æ€»å»¶è¿Ÿ: ~505-3005ms

ååé‡ä¼°ç®— (å‡è®¾ 4 æ ¸ CPU):
- CPU å¯†é›†å‹æ“ä½œ: ~10,000 req/s (åè®®è½¬æ¢)
- å®é™…é™åˆ¶: ä¸Šæ¸¸ API é™æµå’Œå»¶è¿Ÿ
- ç½‘å…³æœ¬èº«ä¸æ˜¯ç“¶é¢ˆ

å»ºè®®å‹åŠ›æµ‹è¯•åœºæ™¯:
- 100 å¹¶å‘ç”¨æˆ·
- æŒç»­ 5 åˆ†é’Ÿ
- æ··åˆè¯·æ±‚ (text, vision, tools)
- é¢„æœŸ: <10ms ç½‘å…³å¼€é”€
```

---

## 8. å®‰å…¨æ€§åˆ†æ

### 8.1 å·²å®ç°çš„å®‰å…¨æªæ–½

| å®‰å…¨æªæ–½ | å®ç°ä½ç½® | æœ‰æ•ˆæ€§ | è¯´æ˜ |
|---------|---------|--------|------|
| **Bearer Token è®¤è¯** | src/auth.rs | â­â­â­â­ | æ ‡å‡† HTTP è®¤è¯ |
| **API Key éªŒè¯** | auth_middleware | â­â­â­â­ | æ£€æŸ¥å¯ç”¨çŠ¶æ€ |
| **è¾“å…¥éªŒè¯** | src/router.rs | â­â­â­â­ | æ¨¡å‹åç™½åå• |
| **è¯·æ±‚å¤§å°é™åˆ¶** | src/server.rs:121 | â­â­â­â­ | 10MB é˜² DoS |
| **æ•æ„Ÿä¿¡æ¯ä¿æŠ¤** | .gitignore | â­â­â­â­ | config.toml ä¸æäº¤ |
| **æ—¥å¿—è„±æ•** | ä½¿ç”¨ api_key_name | â­â­â­â­ | ä¸è®°å½•å®é™… key |

### 8.2 å®‰å…¨é£é™©è¯„ä¼°

#### ğŸ”´ é«˜é£é™©

1. **ç¼ºå°‘ Rate Limiting**
   - å½±å“: å¯èƒ½è¢«æ»¥ç”¨ï¼Œå¯¼è‡´æˆæœ¬å¤±æ§
   - å»ºè®®: å®ç° per-API-key é€Ÿç‡é™åˆ¶
   ```rust
   // å»ºè®®å®ç°
   use governor::{Quota, RateLimiter};

   let limiter = RateLimiter::keyed(Quota::per_minute(100));
   if limiter.check_key(&api_key).is_err() {
       return Err(AppError::RateLimitExceeded);
   }
   ```

2. **API Key åœ¨æ—¥å¿—ä¸­å¯èƒ½æ³„éœ²**
   - å½±å“: å¦‚æœæ—¥å¿—è¢«é”™è¯¯é…ç½®ï¼Œå¯èƒ½æ³„éœ²æ•æ„Ÿä¿¡æ¯
   - å»ºè®®: å®ç°æ—¥å¿—è„±æ•ä¸­é—´ä»¶

#### ğŸŸ¡ ä¸­é£é™©

3. **ç¼ºå°‘ TLS/HTTPS ç»ˆæ­¢**
   - å½±å“: ä¾èµ–å¤–éƒ¨åå‘ä»£ç† (Nginx)
   - å»ºè®®: æ·»åŠ å¯é€‰çš„ TLS æ”¯æŒ

4. **é…ç½®çƒ­é‡è½½æ— éªŒè¯**
   - å½±å“: å¯èƒ½åŠ è½½æ— æ•ˆé…ç½®å¯¼è‡´æœåŠ¡ä¸­æ–­
   - å»ºè®®: åœ¨é‡è½½å‰éªŒè¯é…ç½®

#### ğŸŸ¢ ä½é£é™©

5. **ä¾èµ–ä¾›åº”é“¾**
   - æ‰€æœ‰ä¾èµ–éƒ½æ˜¯ä¸»æµ Rust crate
   - å®šæœŸæ›´æ–°ä¾èµ–ç‰ˆæœ¬

### 8.3 å®‰å…¨åŠ å›ºå»ºè®®

```rust
1. æ·»åŠ  Rate Limiting
   [dependencies]
   governor = "0.6"

2. å®ç° TLS æ”¯æŒ
   [dependencies]
   rustls = "0.21"
   tokio-rustls = "0.24"

3. æ·»åŠ è¯·æ±‚ ID è¿½è¸ª
   X-Request-ID header for tracing

4. å®ç°å®¡è®¡æ—¥å¿—
   è®°å½•æ‰€æœ‰è®¤è¯å¤±è´¥ã€é…ç½®æ›´æ”¹ç­‰

5. å®‰å…¨å¤´éƒ¨
   X-Content-Type-Options: nosniff
   X-Frame-Options: DENY
```

---

## 9. å¯è§‚æµ‹æ€§

### 9.1 Prometheus æŒ‡æ ‡

```
æŒ‡æ ‡è®¾è®¡ (src/metrics.rs):

1. è¯·æ±‚è®¡æ•°
   llm_requests_total{api_key, provider, model, endpoint}
   - ç»´åº¦: 4 ä¸ª
   - ç±»å‹: Counter
   - ç”¨é€”: è¯·æ±‚é‡ç»Ÿè®¡

2. Token ä½¿ç”¨
   llm_tokens_total{api_key, provider, model, type}
   - type: input | output
   - ç±»å‹: Counter
   - ç”¨é€”: æˆæœ¬è®¡ç®—

3. è¯·æ±‚å»¶è¿Ÿ
   llm_request_duration_seconds{api_key, provider, model}
   - ç±»å‹: Histogram
   - åˆ†æ¡¶: [0.1, 0.5, 1, 2, 5, 10, 30]
   - ç”¨é€”: æ€§èƒ½ç›‘æ§

4. é”™è¯¯è®¡æ•°
   llm_errors_total{api_key, provider, model, error_type}
   - ç±»å‹: Counter
   - ç”¨é€”: é”™è¯¯åˆ†æ

5. å®ä¾‹å¥åº·çŠ¶æ€
   llm_gateway_instance_health_status{provider, instance}
   - ç±»å‹: Gauge
   - å€¼: 1 (healthy) | 0 (unhealthy)
   - ç”¨é€”: å®ä¾‹ç›‘æ§

6. å®ä¾‹è¯·æ±‚æ•°
   llm_gateway_instance_requests_total{provider, instance, status}
   - status: success | failure | business_error
   - ç±»å‹: Counter
   - ç”¨é€”: å®ä¾‹æ€§èƒ½åˆ†æ

7. æ´»è·ƒä¼šè¯æ•°
   llm_gateway_session_count{provider}
   - ç±»å‹: Gauge
   - ç”¨é€”: è´Ÿè½½åˆ†æ

8. ç½‘å…³ä¿¡æ¯
   llm_gateway_info{version}
   - ç±»å‹: Gauge
   - ç”¨é€”: ç‰ˆæœ¬è¿½è¸ª
```

### 9.2 æŒ‡æ ‡ç»´åº¦åŸºæ•°åˆ†æ

```
æ½œåœ¨åŸºæ•°çˆ†ç‚¸é£é™©:

é«˜åŸºæ•°ç»´åº¦:
1. api_key: å¯èƒ½æœ‰æ•°ç™¾ä¸ª (å–å†³äºç”¨æˆ·æ•°)
2. model: å¯èƒ½æœ‰æ•°åä¸ª (å–å†³äºæ”¯æŒçš„æ¨¡å‹)
3. instance: é€šå¸¸ 2-5 ä¸ª per provider

åŸºæ•°ä¼°ç®—:
- api_keys: 100
- providers: 3
- models: 30
- instances: 5
- æ€»ç»„åˆ: 100 Ã— 3 Ã— 30 Ã— 5 = 45,000 æ—¶é—´åºåˆ—

Prometheus å†…å­˜å ç”¨ä¼°ç®—:
- æ¯ä¸ªæ—¶é—´åºåˆ—: ~3KB
- 45,000 Ã— 3KB = ~135MB

âš ï¸ é£é™©è¯„ä¼°:
- ä¸­ç­‰é£é™©: å¦‚æœ api_key æ•°é‡æ¿€å¢ (1000+)
- å»ºè®®: ä½¿ç”¨ hash(api_key) æˆ–é™åˆ¶ç»´åº¦
```

### 9.3 æ—¥å¿—ç­–ç•¥

```rust
æ—¥å¿—çº§åˆ«ä½¿ç”¨:

TRACE: è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯ (ç”Ÿäº§ç¯å¢ƒå…³é—­)
DEBUG: è°ƒè¯•ä¿¡æ¯ (å¼€å‘ç¯å¢ƒ)
  - ä¼šè¯é€‰æ‹©è¿‡ç¨‹
  - åè®®è½¬æ¢ç»†èŠ‚

INFO: é‡è¦äº‹ä»¶ (é»˜è®¤çº§åˆ«)
  - æœåŠ¡å¯åŠ¨/åœæ­¢
  - ä¼šè¯åˆ›å»º
  - å®ä¾‹æ¢å¤

WARN: è­¦å‘Š (éœ€è¦å…³æ³¨)
  - å®ä¾‹æ ‡è®°ä¸ºä¸å¥åº·
  - é…ç½®é‡è½½å¤±è´¥
  - åè®®è½¬æ¢è­¦å‘Š

ERROR: é”™è¯¯ (éœ€è¦å¤„ç†)
  - è¯·æ±‚å¤±è´¥
  - ä¸Šæ¸¸ API é”™è¯¯
  - é…ç½®é”™è¯¯

æ—¥å¿—æ ¼å¼: JSON (ä¾¿äºè§£æ)
{
  "timestamp": "2026-01-08T...",
  "level": "INFO",
  "target": "llm_gateway::load_balancer",
  "message": "Created new session",
  "fields": {
    "api_key": "user-app",
    "instance": "anthropic-primary"
  }
}
```

### 9.4 å¯è§‚æµ‹æ€§ç¼ºå£

| ç¼ºå¤±åŠŸèƒ½ | ä¼˜å…ˆçº§ | å»ºè®® |
|---------|--------|------|
| **åˆ†å¸ƒå¼è¿½è¸ª** | ä¸­ | é›†æˆ OpenTelemetry |
| **è¯·æ±‚ ID è¿½è¸ª** | é«˜ | æ·»åŠ  X-Request-ID |
| **æ…¢è¯·æ±‚æ—¥å¿—** | ä¸­ | è®°å½•è¶…è¿‡é˜ˆå€¼çš„è¯·æ±‚ |
| **é”™è¯¯é‡‡æ ·** | ä½ | é‡‡æ ·è®°å½•é”™è¯¯è¯¦æƒ… |
| **æ€§èƒ½å‰–æ** | ä½ | é›†æˆ pprof |

---

## 10. æµ‹è¯•ç­–ç•¥

### 10.1 æµ‹è¯•é‡‘å­—å¡”

```
         â–²
         â”‚  E2E Tests (ç¼ºå¤±)
         â”‚  - å®Œæ•´è¯·æ±‚æµç¨‹
         â”‚  - å¤šæä¾›å•†åˆ‡æ¢
        â”€â”¼â”€
       â•± â”‚ â•²  Integration Tests (éƒ¨åˆ†)
      â•±  â”‚  â•²  - multimodal_tests.rs
     â•±   â”‚   â•²  - tool_calling_tests.rs
    â•±    â”‚    â•²  - json_mode_tests.rs
   â•±â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â•² - caching_tests.rs
  â•±      â”‚      â•²
 â•±   Unit Tests  â•² (è‰¯å¥½)
â•±   (embedded)    â•² - load_balancer
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ - retry, router
                   - error, auth
```

### 10.2 æµ‹è¯•è¦†ç›–è¯¦æƒ…

#### å•å…ƒæµ‹è¯• (âœ… è‰¯å¥½)

```rust
æ¨¡å—                     æµ‹è¯•æ•°  è¦†ç›–ç‡  çŠ¶æ€
---------------------------------------------
load_balancer.rs           3     ~80%   âœ…
  - test_priority_based_selection
  - test_sticky_session
  - test_failover_on_unhealthy

retry.rs                   3     ~85%   âœ…
  - test_is_instance_failure_5xx_errors
  - test_is_instance_failure_4xx_errors
  - test_is_instance_failure_business_errors

router.rs                 11     ~90%   âœ…
  - test_route_openai_model
  - test_route_anthropic_model
  - test_route_gemini_model
  - test_prefix_matching_priority
  - test_route_disabled_provider
  - ... (6 more)

auth.rs                    3     ~70%   âš ï¸ (ignored)
  - test_extract_bearer_token_success
  - test_auth_middleware_valid_key (ignored)
  - test_auth_middleware_invalid_key (ignored)

error.rs                   3     ~80%   âœ…
metrics.rs                 1     ~60%   âš ï¸
```

#### é›†æˆæµ‹è¯• (âš ï¸ éƒ¨åˆ†)

```bash
tests/
â”œâ”€â”€ multimodal_tests.rs      # è§†è§‰åŠŸèƒ½æµ‹è¯•
â”œâ”€â”€ tool_calling_tests.rs    # å·¥å…·è°ƒç”¨æµ‹è¯•
â”œâ”€â”€ json_mode_tests.rs       # JSON æ¨¡å¼æµ‹è¯•
â”œâ”€â”€ caching_tests.rs         # Prompt Caching æµ‹è¯•
â”œâ”€â”€ health_tests.rs          # å¥åº·æ£€æŸ¥æµ‹è¯•
â””â”€â”€ integration_common.rs    # æµ‹è¯•è¾…åŠ©å‡½æ•°

ç¼ºå¤±çš„é›†æˆæµ‹è¯•:
- è´Ÿè½½å‡è¡¡æ•…éšœè½¬ç§»æµ‹è¯•
- å¤šå®ä¾‹å¹¶å‘æµ‹è¯•
- é…ç½®çƒ­é‡è½½æµ‹è¯•
- æµå¼å“åº”å®Œæ•´æ€§æµ‹è¯•
```

#### æ€§èƒ½æµ‹è¯• (âŒ ç¼ºå¤±)

```
å»ºè®®æ·»åŠ :

1. åŸºå‡†æµ‹è¯• (Criterion)
   - load_balancer::select_instance_for_key()
   - protocol conversion overhead
   - JSON serialization

2. å‹åŠ›æµ‹è¯• (wrk, k6)
   - 1000 å¹¶å‘ç”¨æˆ·
   - æŒç»­ 5 åˆ†é’Ÿ
   - æ··åˆè¯·æ±‚ç±»å‹

3. å†…å­˜æ³„æ¼æµ‹è¯•
   - Valgrind / heaptrack
   - é•¿æ—¶é—´è¿è¡Œç›‘æ§
```

### 10.3 æµ‹è¯•ç­–ç•¥å»ºè®®

```rust
ä¼˜å…ˆçº§ 1 (æœ¬å‘¨):
1. è¡¥å…… auth ä¸­é—´ä»¶æµ‹è¯• (ä¿®å¤ #[ignore])
2. æ·»åŠ åè®®è½¬æ¢è¾¹ç•Œæµ‹è¯•
3. æ·»åŠ é”™è¯¯å¤„ç†è¦†ç›–æµ‹è¯•

ä¼˜å…ˆçº§ 2 (ä¸‹å‘¨):
1. ç«¯åˆ°ç«¯é›†æˆæµ‹è¯•
   - å®Œæ•´è¯·æ±‚æµç¨‹
   - æ•…éšœè½¬ç§»åœºæ™¯
2. æ€§èƒ½åŸºå‡†æµ‹è¯•
   - Criterion benchmarks
3. å¹¶å‘å®‰å…¨æµ‹è¯•
   - DashMap å¹¶å‘è¯»å†™
   - RwLock æ­»é”æ£€æµ‹

ä¼˜å…ˆçº§ 3 (1 ä¸ªæœˆ):
1. æ¨¡ç³Šæµ‹è¯• (cargo-fuzz)
   - åè®®è½¬æ¢è¾“å…¥
   - é…ç½®è§£æ
2. å‹åŠ›æµ‹è¯•
   - k6 è„šæœ¬
3. æ··æ²Œå·¥ç¨‹
   - æ¨¡æ‹Ÿä¸Šæ¸¸æ•…éšœ
```

---

## 11. éƒ¨ç½²ä¸è¿ç»´

### 11.1 éƒ¨ç½²æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Production Deployment Architecture                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Internet
   â”‚
   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Load Balancer (Nginx/ALB)          â”‚
â”‚  - TLS ç»ˆæ­¢                          â”‚
â”‚  - åŸºäº API key çš„ä¸€è‡´æ€§å“ˆå¸Œ          â”‚
â”‚  - Health check: /health             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â–¼             â–¼          â–¼          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Gateway â”‚  â”‚Gateway â”‚  â”‚Gateway â”‚  â”‚Gateway â”‚
â”‚  Pod 1 â”‚  â”‚  Pod 2 â”‚  â”‚  Pod 3 â”‚  â”‚  Pod 4 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚             â”‚          â”‚          â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚             â”‚
           â–¼             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚Prometheus â”‚  â”‚  Loki     â”‚
    â”‚(Metrics)  â”‚  â”‚  (Logs)   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ¯ä¸ª Gateway Pod:
- CPU: 1-2 cores
- Memory: 256-512 MB
- Replicas: 3-5 (high availability)
```

### 11.2 Docker éƒ¨ç½²

```dockerfile
# Dockerfile åˆ†æ

# Stage 1: Builder
FROM rust:1.75 as builder
WORKDIR /usr/src/llm-gateway
COPY . .
RUN cargo build --release
# ä¼˜ç‚¹: å¤šé˜¶æ®µæ„å»ºï¼Œå‡å°é•œåƒå¤§å°

# Stage 2: Runtime
FROM debian:bookworm-slim
COPY --from=builder /usr/src/llm-gateway/target/release/llm-gateway /usr/local/bin/
# ä¼˜ç‚¹: æœ€å°è¿è¡Œæ—¶é•œåƒ

ä¼°è®¡é•œåƒå¤§å°:
- Builder é˜¶æ®µ: ~2GB
- æœ€ç»ˆé•œåƒ: ~50-100MB
```

### 11.3 Kubernetes éƒ¨ç½²

```yaml
# å»ºè®®çš„ K8s é…ç½®

apiVersion: apps/v1
kind: Deployment
metadata:
  name: llm-gateway
spec:
  replicas: 3
  selector:
    matchLabels:
      app: llm-gateway
  template:
    metadata:
      labels:
        app: llm-gateway
    spec:
      containers:
      - name: llm-gateway
        image: llm-gateway:0.3.0
        ports:
        - containerPort: 8080
        env:
        - name: RUST_LOG
          value: "info"
        resources:
          requests:
            memory: "256Mi"
            cpu: "500m"
          limits:
            memory: "512Mi"
            cpu: "1000m"
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /ready
            port: 8080
          initialDelaySeconds: 5
          periodSeconds: 5
        volumeMounts:
        - name: config
          mountPath: /app/config.toml
          subPath: config.toml
      volumes:
      - name: config
        secret:
          secretName: llm-gateway-config

---
apiVersion: v1
kind: Service
metadata:
  name: llm-gateway
spec:
  type: ClusterIP
  ports:
  - port: 8080
    targetPort: 8080
  selector:
    app: llm-gateway

---
apiVersion: v1
kind: Service
metadata:
  name: llm-gateway-metrics
spec:
  type: ClusterIP
  ports:
  - port: 9090
    targetPort: 8080
    name: metrics
  selector:
    app: llm-gateway
  # Prometheus å°†æŠ“å– /metrics ç«¯ç‚¹
```

### 11.4 ç›‘æ§å‘Šè­¦é…ç½®

```yaml
# Prometheus å‘Šè­¦è§„åˆ™

groups:
- name: llm_gateway
  interval: 30s
  rules:
  # å®ä¾‹å¥åº·æ£€æŸ¥
  - alert: LLMGatewayInstanceUnhealthy
    expr: llm_gateway_instance_health_status == 0
    for: 2m
    labels:
      severity: warning
    annotations:
      summary: "LLM provider instance unhealthy"
      description: "Instance {{ $labels.instance }} of provider {{ $labels.provider }} has been unhealthy for 2 minutes"

  # é«˜é”™è¯¯ç‡
  - alert: LLMGatewayHighErrorRate
    expr: rate(llm_errors_total[5m]) > 10
    for: 5m
    labels:
      severity: critical
    annotations:
      summary: "High error rate detected"
      description: "Error rate is {{ $value }} errors/sec for {{ $labels.provider }}"

  # æ…¢è¯·æ±‚
  - alert: LLMGatewaySlowRequests
    expr: histogram_quantile(0.95, rate(llm_request_duration_seconds_bucket[5m])) > 10
    for: 10m
    labels:
      severity: warning
    annotations:
      summary: "95th percentile latency is high"
      description: "P95 latency is {{ $value }}s for {{ $labels.provider }}"

  # æ— å¥åº·å®ä¾‹
  - alert: LLMGatewayNoHealthyInstances
    expr: sum(llm_gateway_instance_health_status) by (provider) == 0
    for: 1m
    labels:
      severity: critical
    annotations:
      summary: "No healthy instances available"
      description: "Provider {{ $labels.provider }} has no healthy instances"

  # é«˜ä¼šè¯æ•° (å†…å­˜æ³„æ¼æ£€æµ‹)
  - alert: LLMGatewayHighSessionCount
    expr: llm_gateway_session_count > 10000
    for: 15m
    labels:
      severity: warning
    annotations:
      summary: "High session count detected"
      description: "Session count is {{ $value }} for {{ $labels.provider }}, possible memory leak"
```

### 11.5 è¿ç»´æŒ‡å—

```bash
# å¸¸è§è¿ç»´ä»»åŠ¡

1. å¯åŠ¨æœåŠ¡
   cargo run --release
   # æˆ–
   ./target/release/llm-gateway start

2. å®ˆæŠ¤è¿›ç¨‹æ¨¡å¼
   ./target/release/llm-gateway start --daemon

3. éªŒè¯é…ç½®
   ./target/release/llm-gateway config validate

4. æŸ¥çœ‹é…ç½®
   ./target/release/llm-gateway config show

5. çƒ­é‡è½½é…ç½®
   kill -HUP <pid>
   # æˆ–
   ./target/release/llm-gateway reload

6. ä¼˜é›…å…³é—­
   kill -TERM <pid>

7. æŸ¥çœ‹ç»Ÿè®¡
   ./target/release/llm-gateway stats

8. æŸ¥çœ‹æ—¥å¿— (JSON æ ¼å¼)
   tail -f /var/log/llm-gateway/app.log | jq

9. æŸ¥çœ‹æŒ‡æ ‡
   curl http://localhost:8080/metrics

10. å¥åº·æ£€æŸ¥
    curl http://localhost:8080/health
    curl http://localhost:8080/ready
```

---

## 12. ä¼˜åŠ¿ä¸åˆ›æ–°ç‚¹

### 12.1 æ ¸å¿ƒä¼˜åŠ¿

| ä¼˜åŠ¿ | è¯¦ç»†è¯´æ˜ | ç«äº‰åŠ› |
|-----|---------|--------|
| **é›¶å¤–éƒ¨ä¾èµ–** | æ— éœ€ Redisã€æ•°æ®åº“ç­‰ï¼Œå•äºŒè¿›åˆ¶éƒ¨ç½² | â­â­â­â­â­ |
| **ç²˜æ€§ä¼šè¯** | API key â†’ instance ç»‘å®šï¼Œæœ€å¤§åŒ– KV ç¼“å­˜å‘½ä¸­ | â­â­â­â­â­ |
| **è‡ªåŠ¨æ•…éšœè½¬ç§»** | å•æ¬¡å¤±è´¥å³è§¦å‘ï¼Œæ— éœ€å¤šæ¬¡é‡è¯• | â­â­â­â­â­ |
| **åè®®è½¬æ¢** | è‡ªåŠ¨å®Œæˆ OpenAI â†” Anthropic â†” Gemini è½¬æ¢ | â­â­â­â­â­ |
| **Prompt Caching** | è‡ªåŠ¨æ£€æµ‹å’Œæ ‡è®°ï¼Œ90% æˆæœ¬èŠ‚çº¦ | â­â­â­â­â­ |
| **é«˜æ€§èƒ½** | Rust + Tokioï¼Œä½å»¶è¿Ÿã€é«˜åå | â­â­â­â­â­ |
| **å¤šå®ä¾‹æ”¯æŒ** | æ¯ä¸ªæä¾›å•†æ”¯æŒå¤šä¸ªåç«¯å®ä¾‹ | â­â­â­â­ |
| **ç»Ÿä¸€æ¥å£** | å•ä¸€ OpenAI APIï¼Œæ”¯æŒæ‰€æœ‰æä¾›å•† | â­â­â­â­â­ |

### 12.2 åˆ›æ–°è®¾è®¡

#### 1. ç²˜æ€§ä¼šè¯ + KV ç¼“å­˜ä¼˜åŒ–

```
ä¼ ç»Ÿè´Ÿè½½å‡è¡¡:
User Request 1 â†’ Random Instance A â†’ Provider API (cache miss)
User Request 2 â†’ Random Instance B â†’ Provider API (cache miss)
User Request 3 â†’ Random Instance A â†’ Provider API (cache miss)
é—®é¢˜: æ¯æ¬¡è¯·æ±‚éƒ½å¯èƒ½è·¯ç”±åˆ°ä¸åŒå®ä¾‹ï¼ŒKV ç¼“å­˜æ— æ³•å‘½ä¸­

LLM Gateway è®¾è®¡:
User Request 1 â†’ Instance A (sticky) â†’ Provider API (cache miss)
User Request 2 â†’ Instance A (sticky) â†’ Provider API (cache HIT!)
User Request 3 â†’ Instance A (sticky) â†’ Provider API (cache HIT!)
ä¼˜åŠ¿: åŒä¸€ç”¨æˆ·æ€»æ˜¯è·¯ç”±åˆ°åŒä¸€å®ä¾‹ï¼Œæœ€å¤§åŒ–ç¼“å­˜å‘½ä¸­ç‡

æˆæœ¬èŠ‚çº¦:
- Anthropic KV Cache: 90% æŠ˜æ‰£
- Prompt Caching: 90% æŠ˜æ‰£
- å åŠ æ•ˆæœ: æœ€é«˜å¯è¾¾ 99% æˆæœ¬èŠ‚çº¦
```

#### 2. åŒå±‚ç²˜æ€§æ¶æ„

```
Layer 1 (Nginx):
  Hash(API Key) â†’ Gateway Instance
  ç›®çš„: é¿å…è·¨ç½‘å…³ä¼šè¯åŒæ­¥

Layer 2 (Gateway):
  Session(API Key) â†’ Provider Instance
  ç›®çš„: æœ€å¤§åŒ– KV ç¼“å­˜å‘½ä¸­

ä¼˜åŠ¿:
- å®Œå…¨æ— çŠ¶æ€
- æ— éœ€ Redis å…±äº«ä¼šè¯
- æè‡´æ€§èƒ½ (ä¸¤æ¬¡å“ˆå¸ŒæŸ¥æ‰¾)
```

#### 3. è¢«åŠ¨æ•…éšœæ£€æµ‹ + ä¸»åŠ¨æ¢å¤

```
åˆ›æ–°ç‚¹:
- ä¸è¿›è¡Œä¸»åŠ¨å¥åº·æ¢æµ‹ (é¿å…é¢å¤–è¯·æ±‚æˆæœ¬)
- å•æ¬¡å¤±è´¥å³æ ‡è®°ä¸å¥åº· (å¿«é€Ÿå“åº”)
- åŸºäºæ—¶é—´çš„è‡ªåŠ¨æ¢å¤ (å‡å°‘å¤æ‚åº¦)
- æ¸è¿›å¼æ¢å¤ (é˜²æ­¢æŠ–åŠ¨)

å¯¹æ¯”ä¼ ç»Ÿæ–¹æ¡ˆ:
ä¼ ç»Ÿ: 3 æ¬¡å¤±è´¥ â†’ æ ‡è®°ä¸å¥åº· â†’ ä¸»åŠ¨æ¢æµ‹ â†’ æ¢å¤
LLM Gateway: 1 æ¬¡å¤±è´¥ â†’ æ ‡è®°ä¸å¥åº· â†’ 60ç§’åè‡ªåŠ¨æ¢å¤

ä¼˜åŠ¿:
- æ›´å¿«çš„æ•…éšœæ£€æµ‹
- æ›´ä½çš„è¿ç»´æˆæœ¬
- æ›´ç®€å•çš„å®ç°
```

#### 4. è‡ªåŠ¨ Prompt Caching

```
ä¼ ç»Ÿæ–¹å¼:
å¼€å‘è€…æ‰‹åŠ¨æ·»åŠ  cache_control:
{
  "system": [{
    "type": "text",
    "text": "...",
    "cache_control": {"type": "ephemeral"}  // æ‰‹åŠ¨æ·»åŠ 
  }]
}

LLM Gateway è‡ªåŠ¨åŒ–:
å¼€å‘è€…å‘é€æ ‡å‡† OpenAI è¯·æ±‚:
{
  "messages": [
    {"role": "system", "content": "..."}  // æ— éœ€ä¿®æ”¹
  ]
}

ç½‘å…³è‡ªåŠ¨:
1. è®¡ç®— tokens (tiktoken-rs)
2. å¦‚æœ â‰¥ 1024 tokens:
   - è‡ªåŠ¨è½¬æ¢æ ¼å¼
   - è‡ªåŠ¨æ·»åŠ  cache_control
3. é€æ˜ä¼ è¾“ç»™ Anthropic

ä¼˜åŠ¿:
- å¼€å‘è€…æ— éœ€ä¿®æ”¹ä»£ç 
- è‡ªåŠ¨æˆæœ¬ä¼˜åŒ–
- ç»Ÿä¸€çš„ OpenAI æ¥å£
```

---

## 13. æ”¹è¿›æœºä¼š

### 13.1 åŠŸèƒ½ç¼ºå£

| ç¼ºå¤±åŠŸèƒ½ | ä¼˜å…ˆçº§ | å½±å“ | å·¥ä½œé‡ | ROI |
|---------|--------|------|--------|-----|
| **Rate Limiting** | ğŸ”´ é«˜ | æˆæœ¬æ§åˆ¶ã€æ»¥ç”¨é˜²æŠ¤ | ä¸­ | â­â­â­â­â­ |
| **ä¸»åŠ¨å¥åº·æ£€æŸ¥** | ğŸŸ¡ ä¸­ | æé«˜å¯é æ€§ | ä¸­ | â­â­â­â­ |
| **æƒé‡è´Ÿè½½å‡è¡¡** | ğŸŸ¡ ä¸­ | çµæ´»çš„æµé‡åˆ†é… | å° | â­â­â­ |
| **è¯·æ±‚çº§è¶…æ—¶** | ğŸŸ¡ ä¸­ | èµ„æºä¿æŠ¤ | å° | â­â­â­â­ |
| **åˆ†å¸ƒå¼è¿½è¸ª** | ğŸŸ¢ ä½ | å¯è§‚æµ‹æ€§å¢å¼º | å¤§ | â­â­ |
| **é…ç½® UI** | ğŸŸ¢ ä½ | è¿ç»´ä½“éªŒ | å¤§ | â­â­ |
| **å¤šç§Ÿæˆ·éš”ç¦»** | ğŸŸ¢ ä½ | ä¼ä¸šç‰¹æ€§ | å¤§ | â­â­â­ |

### 13.2 ä»£ç è´¨é‡æ”¹è¿›

```
ä¼˜å…ˆçº§ 1 (ç«‹å³):
1. ç»Ÿä¸€é”™è¯¯ç±»å‹ (ç§»é™¤ HttpClientError)
2. æ·»åŠ é…ç½®éªŒè¯
3. ä¿®å¤æ—¥å¿—æ•æ„Ÿä¿¡æ¯æ³„éœ²é£é™©

ä¼˜å…ˆçº§ 2 (1-2 å‘¨):
1. å‡å°‘ä»£ç é‡å¤ (æµ‹è¯•è¾…åŠ©å‡½æ•°)
2. æ·»åŠ æ›´å¤šæ–‡æ¡£æ³¨é‡Š
3. ä¼˜åŒ–æŒ‡æ ‡ç»´åº¦ (é˜²æ­¢åŸºæ•°çˆ†ç‚¸)

ä¼˜å…ˆçº§ 3 (1 ä¸ªæœˆ):
1. åè®®è½¬æ¢å™¨ç‰ˆæœ¬ç®¡ç†
2. æ€§èƒ½åŸºå‡†æµ‹è¯•
3. é›†æˆæµ‹è¯•å®Œå–„
```

### 13.3 æ¶æ„ä¼˜åŒ–

```
çŸ­æœŸä¼˜åŒ–:
1. æ·»åŠ è¯·æ±‚çº§è¶…æ—¶æ§åˆ¶
2. å®ç°ä¸»åŠ¨å¥åº·æ£€æŸ¥
3. æ·»åŠ  Rate Limiting

ä¸­æœŸä¼˜åŒ–:
1. æ”¯æŒæ›´å¤š LLM æä¾›å•†
   - Cohere
   - Mistral
   - Together AI
2. å¢å¼ºåè®®è½¬æ¢
   - æ”¯æŒæ›´å¤š OpenAI å‚æ•°
   - æ›´å¥½çš„é”™è¯¯æ˜ å°„
3. æ€§èƒ½ä¼˜åŒ–
   - è¿æ¥æ± è°ƒä¼˜
   - å‡å°‘ Arc clone
   - é›¶æ‹·è´ä¼˜åŒ–

é•¿æœŸä¼˜åŒ–:
1. æ’ä»¶ç³»ç»Ÿ
   - è‡ªå®šä¹‰ä¸­é—´ä»¶
   - è‡ªå®šä¹‰æä¾›å•†
2. æ™ºèƒ½è·¯ç”±
   - åŸºäºæˆæœ¬çš„è·¯ç”±
   - åŸºäºå»¶è¿Ÿçš„è·¯ç”±
   - A/B æµ‹è¯•æ”¯æŒ
3. é«˜çº§ç‰¹æ€§
   - è¯·æ±‚åˆå¹¶ (batching)
   - å“åº”ç¼“å­˜
   - é¢„æµ‹æ€§æ‰©ç¼©å®¹
```

---

## 14. ç«äº‰åˆ†æ

### 14.1 ç«å“å¯¹æ¯”

| ç‰¹æ€§ | LLM Gateway | LiteLLM | Portkey | OpenRouter |
|-----|------------|---------|---------|------------|
| **éƒ¨ç½²æ¨¡å¼** | âœ… è‡ªæ‰˜ç®¡ | âœ… è‡ªæ‰˜ç®¡ | âŒ SaaS | âŒ SaaS |
| **é›¶å¤–éƒ¨ä¾èµ–** | âœ… æ˜¯ | âŒ å¦ (éœ€ Redis) | N/A | N/A |
| **ç¼–ç¨‹è¯­è¨€** | Rust | Python | ? | ? |
| **æ€§èƒ½** | â­â­â­â­â­ | â­â­â­ | â­â­â­â­ | â­â­â­â­ |
| **ç²˜æ€§ä¼šè¯** | âœ… æ˜¯ | âŒ å¦ | ? | ? |
| **å¤šå®ä¾‹ LB** | âœ… æ˜¯ | âŒ å¦ | âœ… æ˜¯ | âœ… æ˜¯ |
| **åè®®è½¬æ¢** | âœ… è‡ªåŠ¨ | âœ… è‡ªåŠ¨ | âœ… è‡ªåŠ¨ | âœ… è‡ªåŠ¨ |
| **Prompt Caching** | âœ… è‡ªåŠ¨åŒ– | âš ï¸ æ‰‹åŠ¨ | âœ… æ˜¯ | ? |
| **å¼€æº** | âœ… MIT | âœ… MIT | âŒ å¦ | âŒ å¦ |
| **æˆæœ¬** | $0 | $0 | $$$ | $$ |

### 14.2 å·®å¼‚åŒ–ä¼˜åŠ¿

```
LLM Gateway çš„ç‹¬ç‰¹ä»·å€¼:

1. æç®€éƒ¨ç½² â­â­â­â­â­
   - å•äºŒè¿›åˆ¶ + é…ç½®æ–‡ä»¶
   - æ— éœ€ Redis/æ•°æ®åº“
   - Docker é•œåƒ < 100MB

2. æ€§èƒ½æè‡´ â­â­â­â­â­
   - Rust é›¶æˆæœ¬æŠ½è±¡
   - é«˜æ•ˆå¹¶å‘ (Tokio)
   - ä½å»¶è¿Ÿ (<5ms å†…éƒ¨å¼€é”€)

3. æˆæœ¬ä¼˜åŒ– â­â­â­â­â­
   - ç²˜æ€§ä¼šè¯ â†’ KV ç¼“å­˜å‘½ä¸­
   - è‡ªåŠ¨ Prompt Caching
   - æœ€é«˜ 99% æˆæœ¬èŠ‚çº¦

4. ç®€å•å¯é  â­â­â­â­â­
   - æ¸…æ™°çš„æ¶æ„
   - æ˜“äºç†è§£çš„ä»£ç 
   - è¯¦ç»†çš„æ–‡æ¡£

å¯¹æ¯” Python å®ç° (LiteLLM):
- æ€§èƒ½: 2-5x æ›´å¿«
- å†…å­˜: 3-10x æ›´ä½
- å¯åŠ¨: 10x æ›´å¿«
- éƒ¨ç½²: æ›´ç®€å• (æ— éœ€ Python ç¯å¢ƒ)
```

### 14.3 å¸‚åœºå®šä½

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LLM Gateway å¸‚åœºå®šä½                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç›®æ ‡å¸‚åœº:
1. åˆåˆ›å…¬å¸ / ä¸­å°ä¼ä¸š
   - éœ€è¦ç®€å•éƒ¨ç½²
   - å…³æ³¨æˆæœ¬ä¼˜åŒ–
   - æœ‰é™çš„è¿ç»´èµ„æº

2. å¼€å‘è€… / æŠ€æœ¯å›¢é˜Ÿ
   - éœ€è¦å®Œå…¨æ§åˆ¶
   - åå¥½è‡ªæ‰˜ç®¡
   - å…³æ³¨æ€§èƒ½å’Œå¯é æ€§

3. éšç§æ•æ„Ÿè¡Œä¸š
   - åŒ»ç–—ã€é‡‘èã€æ”¿åºœ
   - ä¸èƒ½ä½¿ç”¨ SaaS
   - éœ€è¦æœ¬åœ°éƒ¨ç½²

ä¸é€‚åˆåœºæ™¯:
1. è¶…å¤§è§„æ¨¡ä¼ä¸š (>10000 QPS)
   â†’ éœ€è¦æ›´å¤æ‚çš„åˆ†å¸ƒå¼æ¶æ„

2. éœ€è¦é«˜çº§åˆ†æ / BI
   â†’ SaaS å¹³å° (Portkey) æ›´åˆé€‚

3. é›¶è¿ç»´éœ€æ±‚
   â†’ OpenRouter ç­‰æ‰˜ç®¡æœåŠ¡æ›´åˆé€‚
```

---

## 15. æœªæ¥å‘å±•å»ºè®®

### 15.1 äº§å“è·¯çº¿å›¾ (6 ä¸ªæœˆ)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Roadmap: Next 6 Months                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Month 1-2: ç¨³å®šæ€§ä¸å®‰å…¨æ€§
â”œâ”€ Rate Limiting (per API key)
â”œâ”€ ä¸»åŠ¨å¥åº·æ£€æŸ¥
â”œâ”€ é…ç½®éªŒè¯å’Œçƒ­é‡è½½æ”¹è¿›
â”œâ”€ å®‰å…¨åŠ å›º (æ—¥å¿—è„±æ•ã€å®¡è®¡)
â””â”€ æ€§èƒ½åŸºå‡†æµ‹è¯•

Month 3-4: åŠŸèƒ½å¢å¼º
â”œâ”€ æƒé‡è´Ÿè½½å‡è¡¡
â”œâ”€ è¯·æ±‚çº§è¶…æ—¶æ§åˆ¶
â”œâ”€ æ›´å¤šæä¾›å•†æ”¯æŒ
â”‚   â”œâ”€ Cohere
â”‚   â”œâ”€ Mistral
â”‚   â””â”€ Together AI
â”œâ”€ å¢å¼ºåè®®è½¬æ¢
â””â”€ é›†æˆæµ‹è¯•å®Œå–„

Month 5-6: é«˜çº§ç‰¹æ€§
â”œâ”€ åˆ†å¸ƒå¼è¿½è¸ª (OpenTelemetry)
â”œâ”€ æ™ºèƒ½è·¯ç”±
â”‚   â”œâ”€ åŸºäºæˆæœ¬
â”‚   â”œâ”€ åŸºäºå»¶è¿Ÿ
â”‚   â””â”€ A/B æµ‹è¯•
â”œâ”€ å“åº”ç¼“å­˜ (å¯é€‰)
â”œâ”€ è¯·æ±‚åˆå¹¶ (batching)
â””â”€ é…ç½® UI (Web ç•Œé¢)
```

### 15.2 æŠ€æœ¯æ¼”è¿›æ–¹å‘

```
æ¶æ„æ¼”è¿›:

v0.3 (å½“å‰): å•æœºé«˜æ€§èƒ½ç½‘å…³
  â”œâ”€ é›¶å¤–éƒ¨ä¾èµ–
  â”œâ”€ ç²˜æ€§ä¼šè¯
  â””â”€ è‡ªåŠ¨æ•…éšœè½¬ç§»

v0.4 (3 ä¸ªæœˆ): å¢å¼ºå¯é æ€§
  â”œâ”€ Rate Limiting
  â”œâ”€ ä¸»åŠ¨å¥åº·æ£€æŸ¥
  â”œâ”€ é…ç½®éªŒè¯
  â””â”€ å®‰å…¨åŠ å›º

v0.5 (6 ä¸ªæœˆ): åŠŸèƒ½å®Œå–„
  â”œâ”€ æ›´å¤šæä¾›å•†
  â”œâ”€ æ™ºèƒ½è·¯ç”±
  â”œâ”€ åˆ†å¸ƒå¼è¿½è¸ª
  â””â”€ é…ç½® UI

v1.0 (12 ä¸ªæœˆ): ä¼ä¸šçº§ç‰¹æ€§
  â”œâ”€ å¤šç§Ÿæˆ·éš”ç¦»
  â”œâ”€ é«˜çº§åˆ†æ
  â”œâ”€ æ’ä»¶ç³»ç»Ÿ
  â””â”€ è‡ªåŠ¨æ‰©ç¼©å®¹

v2.0 (æœªæ¥): å¹³å°åŒ–
  â”œâ”€ SaaS é€‰é¡¹
  â”œâ”€ Marketplace
  â”œâ”€ AI è¾…åŠ©ä¼˜åŒ–
  â””â”€ æˆæœ¬é¢„æµ‹
```

### 15.3 ç¤¾åŒºå»ºè®¾

```
å¼€æºç­–ç•¥:

1. æ–‡æ¡£å®Œå–„
   â”œâ”€ API å‚è€ƒæ–‡æ¡£
   â”œâ”€ éƒ¨ç½²æŒ‡å—
   â”œâ”€ æœ€ä½³å®è·µ
   â””â”€ è§†é¢‘æ•™ç¨‹

2. ç¤¾åŒºå‚ä¸
   â”œâ”€ Discord / Slack é¢‘é“
   â”œâ”€ å®šæœŸ Office Hours
   â”œâ”€ Contributor Guidelines
   â””â”€ Issue æ¨¡æ¿

3. ç”Ÿæ€ç³»ç»Ÿ
   â”œâ”€ Helm Chart (Kubernetes)
   â”œâ”€ Terraform æ¨¡å—
   â”œâ”€ Docker Compose æ¨¡æ¿
   â””â”€ é›†æˆç¤ºä¾‹ (Cursor, VS Code, etc.)

4. æ¨å¹¿
   â”œâ”€ æŠ€æœ¯åšå®¢
   â”œâ”€ ä¼šè®®æ¼”è®²
   â”œâ”€ æ¡ˆä¾‹ç ”ç©¶
   â””â”€ Benchmark å¯¹æ¯”
```

### 15.4 å•†ä¸šåŒ–è·¯å¾„ (å¯é€‰)

```
å¼€æº + å•†ä¸šæ¨¡å¼:

å¼€æºç‰ˆæœ¬ (MIT):
âœ… æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½
âœ… ç¤¾åŒºæ”¯æŒ
âœ… è‡ªæ‰˜ç®¡éƒ¨ç½²

ä¼ä¸šç‰ˆæœ¬ (ä»˜è´¹):
ğŸ’° é«˜çº§åŠŸèƒ½
  â”œâ”€ å¤šç§Ÿæˆ·éš”ç¦»
  â”œâ”€ é«˜çº§åˆ†æå’Œ BI
  â”œâ”€ SLA ä¿è¯
  â””â”€ ä¼˜å…ˆæ”¯æŒ

ğŸ’° SaaS æ‰˜ç®¡
  â”œâ”€ å®Œå…¨æ‰˜ç®¡æœåŠ¡
  â”œâ”€ è‡ªåŠ¨æ‰©ç¼©å®¹
  â”œâ”€ å…¨çƒ CDN
  â””â”€ 99.99% SLA

ğŸ’° ä¼ä¸šæ”¯æŒ
  â”œâ”€ ä¸“å±æŠ€æœ¯æ”¯æŒ
  â”œâ”€ å®šåˆ¶å¼€å‘
  â”œâ”€ åŸ¹è®­æœåŠ¡
  â””â”€ å’¨è¯¢æœåŠ¡

å®šä»·ç­–ç•¥:
- å¼€æº: å…è´¹
- ä¼ä¸šè®¸å¯: $499/æœˆ
- SaaS: $0.01/1K tokens
- ä¼ä¸šæ”¯æŒ: $5K/æœˆèµ·
```

---

## 16. æ€»ç»“ä¸å»ºè®®

### 16.1 é¡¹ç›®æ€»ä½“è¯„ä»·

**LLM Gateway æ˜¯ä¸€ä¸ªä¼˜ç§€çš„ä¼ä¸šçº§ Rust é¡¹ç›®**ï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š

âœ… **æ¶æ„ä¼˜ç§€**: æ¸…æ™°çš„åˆ†å±‚æ¶æ„ï¼ŒèŒè´£åˆ†ç¦»æ˜ç¡®
âœ… **æ€§èƒ½å“è¶Š**: Rust + Tokioï¼Œé«˜å¹¶å‘ã€ä½å»¶è¿Ÿ
âœ… **åŠŸèƒ½å®Œå–„**: æ”¯æŒå¤šæä¾›å•†ã€åè®®è½¬æ¢ã€è´Ÿè½½å‡è¡¡ã€æ•…éšœè½¬ç§»
âœ… **åˆ›æ–°è®¾è®¡**: ç²˜æ€§ä¼šè¯ã€è‡ªåŠ¨ Prompt Cachingã€é›¶å¤–éƒ¨ä¾èµ–
âœ… **ä»£ç è´¨é‡**: è‰¯å¥½çš„ Rust å®è·µï¼Œæµ‹è¯•è¦†ç›–è¾ƒå¥½
âœ… **æ–‡æ¡£è¯¦ç»†**: CLAUDE.mdã€README.mdã€CODE_REVIEW.md

âš ï¸ **éœ€è¦æ”¹è¿›**:
- æ·»åŠ  Rate Limitingï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰
- å®ç°ä¸»åŠ¨å¥åº·æ£€æŸ¥
- ä¼˜åŒ–æŒ‡æ ‡ç»´åº¦è®¾è®¡
- è¡¥å……é›†æˆæµ‹è¯•å’Œæ€§èƒ½æµ‹è¯•
- é…ç½®éªŒè¯å’Œå®‰å…¨åŠ å›º

**æ€»ä½“è¯„åˆ†**: â­â­â­â­ (4.3/5.0)

### 16.2 å…³é”®å»ºè®®

#### ç«‹å³æ‰§è¡Œ (æœ¬å‘¨)

1. **å®‰å…¨åŠ å›º**
   - å®ç° Rate Limiting
   - å®¡æŸ¥æ—¥å¿—æ•æ„Ÿä¿¡æ¯
   - æ·»åŠ é…ç½®éªŒè¯

2. **é”™è¯¯å¤„ç†ä¼˜åŒ–**
   - ç»Ÿä¸€é”™è¯¯ç±»å‹
   - æ”¹è¿›é”™è¯¯ä¿¡æ¯

3. **æµ‹è¯•è¡¥å……**
   - ä¿®å¤ ignored æµ‹è¯•
   - æ·»åŠ é›†æˆæµ‹è¯•

#### çŸ­æœŸè®¡åˆ’ (1-2 å‘¨)

1. **å¥åº·æ£€æŸ¥å¢å¼º**
   - å®ç°ä¸»åŠ¨å¥åº·æ¢æµ‹
   - æ”¹è¿›æ¢å¤ç­–ç•¥

2. **è´Ÿè½½å‡è¡¡ä¼˜åŒ–**
   - æ·»åŠ æƒé‡æ”¯æŒ
   - è¯·æ±‚çº§è¶…æ—¶

3. **å¯è§‚æµ‹æ€§æå‡**
   - ä¼˜åŒ–æŒ‡æ ‡ç»´åº¦
   - æ·»åŠ è¯·æ±‚ ID è¿½è¸ª

#### ä¸­æœŸç›®æ ‡ (1-3 ä¸ªæœˆ)

1. **åŠŸèƒ½æ‰©å±•**
   - æ”¯æŒæ›´å¤š LLM æä¾›å•†
   - æ™ºèƒ½è·¯ç”±ï¼ˆåŸºäºæˆæœ¬ã€å»¶è¿Ÿï¼‰
   - åˆ†å¸ƒå¼è¿½è¸ª

2. **æ€§èƒ½ä¼˜åŒ–**
   - æ€§èƒ½åŸºå‡†æµ‹è¯•
   - è¿æ¥æ± è°ƒä¼˜
   - é›¶æ‹·è´ä¼˜åŒ–

3. **ç”Ÿæ€å»ºè®¾**
   - Helm Chart
   - éƒ¨ç½²æŒ‡å—
   - æœ€ä½³å®è·µæ–‡æ¡£

### 16.3 æˆåŠŸå…³é”®å› ç´ 

```
æŠ€æœ¯æ–¹é¢:
1. ä¿æŒ Rust æ€§èƒ½ä¼˜åŠ¿
2. æŒç»­ä¼˜åŒ–æ¶æ„
3. å®Œå–„æµ‹è¯•è¦†ç›–
4. æ³¨é‡å®‰å…¨å’Œå¯é æ€§

äº§å“æ–¹é¢:
1. èšç„¦æ ¸å¿ƒä»·å€¼ (ç®€å•ã€é«˜æ€§èƒ½ã€ä½æˆæœ¬)
2. å€¾å¬ç”¨æˆ·åé¦ˆ
3. å¿«é€Ÿè¿­ä»£
4. ä¿æŒæ–‡æ¡£æ›´æ–°

ç¤¾åŒºæ–¹é¢:
1. æ´»è·ƒçš„ç»´æŠ¤
2. å‹å¥½çš„è´¡çŒ®è€…æ–‡åŒ–
3. åŠæ—¶çš„é—®é¢˜å“åº”
4. å®šæœŸå‘å¸ƒæ–°ç‰ˆæœ¬
```

### 16.4 æœ€ç»ˆå»ºè®®

LLM Gateway å·²ç»æ˜¯ä¸€ä¸ª**ç”Ÿäº§å°±ç»ª (Production-Ready)** çš„é¡¹ç›®ï¼Œå…·å¤‡ä»¥ä¸‹æ¡ä»¶ï¼š

âœ… æ ¸å¿ƒåŠŸèƒ½å®Œæ•´
âœ… æ€§èƒ½ä¼˜å¼‚
âœ… æ¶æ„æ¸…æ™°
âœ… ä»£ç è´¨é‡é«˜
âœ… æ–‡æ¡£è¯¦ç»†

**ä¸‹ä¸€æ­¥è¡ŒåŠ¨**:

1. **ç¨³å®šç°æœ‰åŠŸèƒ½** (1 ä¸ªæœˆ)
   - ä¿®å¤å·²çŸ¥é—®é¢˜
   - è¡¥å……æµ‹è¯•
   - å®‰å…¨åŠ å›º

2. **æ‰©å±•æ ¸å¿ƒä»·å€¼** (3 ä¸ªæœˆ)
   - Rate Limiting
   - ä¸»åŠ¨å¥åº·æ£€æŸ¥
   - æ›´å¤šæä¾›å•†æ”¯æŒ

3. **æ„å»ºç”Ÿæ€ç³»ç»Ÿ** (6 ä¸ªæœˆ)
   - éƒ¨ç½²å·¥å…· (Helm, Terraform)
   - é›†æˆç¤ºä¾‹
   - ç¤¾åŒºå»ºè®¾

4. **æ¢ç´¢å•†ä¸šåŒ–** (12 ä¸ªæœˆ)
   - ä¼ä¸šç‰ˆç‰¹æ€§
   - SaaS æ‰˜ç®¡é€‰é¡¹
   - ä¼ä¸šæ”¯æŒæœåŠ¡

---

**é¡¹ç›®æ½œåŠ›**: â­â­â­â­â­
**æ¨èä½¿ç”¨åœºæ™¯**: ä¸­å°ä¼ä¸šã€å¼€å‘è€…å›¢é˜Ÿã€éšç§æ•æ„Ÿè¡Œä¸š
**æ ¸å¿ƒç«äº‰åŠ›**: ç®€å•ã€é«˜æ€§èƒ½ã€ä½æˆæœ¬ã€é›¶å¤–éƒ¨ä¾èµ–

**LLM Gateway æœ‰æ½œåŠ›æˆä¸º LLM ä»£ç†ç½‘å…³é¢†åŸŸçš„æ ‡å‡†å¼€æºè§£å†³æ–¹æ¡ˆã€‚**

---

**æŠ¥å‘Šå®Œæˆæ—¥æœŸ**: 2026-01-08
**åˆ†æäºº**: Claude Code Analysis Agent
**æŠ¥å‘Šç‰ˆæœ¬**: 1.0
